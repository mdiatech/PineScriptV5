
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  
<!-- Mirrored from www.tradingview.com/pine-script-docs/en/v5/concepts/Strategies.html by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 04 Sep 2023 17:56:28 GMT -->
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="../_static/fonts/open-sans/stylesheet.css" />
  <!-- Licensed under the SIL Open Font License -->
  <link rel="stylesheet" type="text/css" href="../_static/fonts/source-serif-pro/source-serif-pro.css" />
  <link rel="stylesheet" type="text/css" href="../_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="../_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>Strategies &#8212; Pine Script® v5 User Manual v5 documentation</title>
    <link rel="stylesheet" href="../_static/guzzle.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <script type="text/javascript" src="../../../../../static.tradingview.com/static/bundles/pine-highlighter-v01.js"></script>
    <script type="text/javascript" src="../_static/highlight-pine-code.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Tables" href="Tables.html" />
    <link rel="prev" title="Sessions" href="Sessions.html" />
  
   

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="Tables.html" title="Tables"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Sessions.html" title="Sessions"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Pine Script® v5 User Manual v5 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Concepts</a> &#187;</li> 
      </ul>
    </div>
    <div class="container-wrapper">

      <div id="mobile-toggle">
        <a href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
      </div>
  <div id="left-column">
    <div class="sphinxsidebar"><a href="../index.html" class="text-logo">Pine Script<sup>®</sup> v5 User Manual</a>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <h2>Table Of Contents</h2>
  </div>
  <div class="sidebar-toc">
    
    
      <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Introduction.html">Welcome to Pine Script<sup>®</sup> v5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../primer/index.html">Pine Script<sup>®</sup> primer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../language/index.html">Language</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Concepts</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Alerts.html">Alerts</a></li>
<li class="toctree-l2"><a class="reference internal" href="Backgrounds.html">Backgrounds</a></li>
<li class="toctree-l2"><a class="reference internal" href="Bar_coloring.html">Bar coloring</a></li>
<li class="toctree-l2"><a class="reference internal" href="Bar_plotting.html">Bar plotting</a></li>
<li class="toctree-l2"><a class="reference internal" href="Bar_states.html">Bar states</a></li>
<li class="toctree-l2"><a class="reference internal" href="Chart_information.html">Chart information</a></li>
<li class="toctree-l2"><a class="reference internal" href="Colors.html">Colors</a></li>
<li class="toctree-l2"><a class="reference internal" href="Fills.html">Fills</a></li>
<li class="toctree-l2"><a class="reference internal" href="Inputs.html">Inputs</a></li>
<li class="toctree-l2"><a class="reference internal" href="Levels.html">Levels</a></li>
<li class="toctree-l2"><a class="reference internal" href="Libraries.html">Libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="Lines_and_boxes.html">Lines and boxes</a></li>
<li class="toctree-l2"><a class="reference internal" href="Non-standard_charts_data.html">Non-standard charts data</a></li>
<li class="toctree-l2"><a class="reference internal" href="Plots.html">Plots</a></li>
<li class="toctree-l2"><a class="reference internal" href="Repainting.html">Repainting</a></li>
<li class="toctree-l2"><a class="reference internal" href="Sessions.html">Sessions</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Strategies</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#a-simple-strategy-example">A simple strategy example</a></li>
<li class="toctree-l3"><a class="reference internal" href="#applying-a-strategy-to-a-chart">Applying a strategy to a chart</a></li>
<li class="toctree-l3"><a class="reference internal" href="#strategy-tester">Strategy tester</a></li>
<li class="toctree-l3"><a class="reference internal" href="#broker-emulator">Broker emulator</a></li>
<li class="toctree-l3"><a class="reference internal" href="#orders-and-entries">Orders and entries</a></li>
<li class="toctree-l3"><a class="reference internal" href="#position-sizing">Position sizing</a></li>
<li class="toctree-l3"><a class="reference internal" href="#closing-a-market-position">Closing a market position</a></li>
<li class="toctree-l3"><a class="reference internal" href="#oca-groups">OCA groups</a></li>
<li class="toctree-l3"><a class="reference internal" href="#currency">Currency</a></li>
<li class="toctree-l3"><a class="reference internal" href="#altering-calculation-behavior">Altering calculation behavior</a></li>
<li class="toctree-l3"><a class="reference internal" href="#simulating-trading-costs">Simulating trading costs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#risk-management">Risk management</a></li>
<li class="toctree-l3"><a class="reference internal" href="#margin">Margin</a></li>
<li class="toctree-l3"><a class="reference internal" href="#strategy-alerts">Strategy Alerts</a></li>
<li class="toctree-l3"><a class="reference internal" href="#notes-on-testing-strategies">Notes on testing strategies</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="Tables.html">Tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="Text_and_shapes.html">Text and shapes</a></li>
<li class="toctree-l2"><a class="reference internal" href="Time.html">Time</a></li>
<li class="toctree-l2"><a class="reference internal" href="Timeframes.html">Timeframes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../writing/index.html">Writing scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Error_messages.html">Error messages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Release_notes.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../migration_guides/index.html">Migration guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Where_can_I_get_more_information.html">Where can I get more information?</a></li>
</ul>

    
  </div>
</div>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <div id="main-search">
      <form class="form-inline" action="https://www.tradingview.com/pine-script-docs/en/v5/search.html" method="GET" role="form">
        <div class="input-group">
          <input name="q" type="text" class="form-control" placeholder="Search...">
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div>
      
    </div>
  </div>
        <div id="right-column">
          
          <div role="navigation" aria-label="breadcrumbs navigation">
            <ol class="breadcrumb">
              <li><a href="../index.html">User Manual</a></li>
              
                <li><a href="index.html">Concepts</a></li>
              
              <li>Strategies</li>
            </ol>
          </div>
          
          <div class="document clearer body">
            
  <a class="reference external image-reference" href="../Introduction.html"><div align="right" class="align-right"><img alt="Pine Script® logo" height="100" src="../_images/Pine-script-logo.svg" width="100" /></div>
</a>
<div class="section" id="strategies">
<span id="pagestrategies"></span><h1>Strategies<a class="headerlink" href="#strategies" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id1">Introduction</a></li>
<li><a class="reference internal" href="#a-simple-strategy-example" id="id2">A simple strategy example</a></li>
<li><a class="reference internal" href="#applying-a-strategy-to-a-chart" id="id3">Applying a strategy to a chart</a></li>
<li><a class="reference internal" href="#strategy-tester" id="id4">Strategy tester</a><ul>
<li><a class="reference internal" href="#overview" id="id5">Overview</a></li>
<li><a class="reference internal" href="#performance-summary" id="id6">Performance summary</a></li>
<li><a class="reference internal" href="#list-of-trades" id="id7">List of trades</a></li>
<li><a class="reference internal" href="#properties" id="id8">Properties</a></li>
</ul>
</li>
<li><a class="reference internal" href="#broker-emulator" id="id9">Broker emulator</a><ul>
<li><a class="reference internal" href="#bar-magnifier" id="id10">Bar magnifier</a></li>
</ul>
</li>
<li><a class="reference internal" href="#orders-and-entries" id="id11">Orders and entries</a><ul>
<li><a class="reference internal" href="#order-types" id="id12">Order types</a><ul>
<li><a class="reference internal" href="#market-orders" id="id13">Market orders</a></li>
<li><a class="reference internal" href="#limit-orders" id="id14">Limit orders</a></li>
<li><a class="reference internal" href="#stop-and-stop-limit-orders" id="id15">Stop and stop-limit orders</a></li>
</ul>
</li>
<li><a class="reference internal" href="#order-placement-commands" id="id16">Order placement commands</a><ul>
<li><a class="reference internal" href="#strategy-entry" id="id17">`strategy.entry()`</a></li>
<li><a class="reference internal" href="#strategy-order" id="id18">`strategy.order()`</a></li>
<li><a class="reference internal" href="#strategy-exit" id="id19">`strategy.exit()`</a></li>
<li><a class="reference internal" href="#strategy-close-and-strategy-close-all" id="id20">`strategy.close()` and `strategy.close_all()`</a></li>
<li><a class="reference internal" href="#strategy-cancel-and-strategy-cancel-all" id="id21">`strategy.cancel()` and `strategy.cancel_all()`</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#position-sizing" id="id22">Position sizing</a></li>
<li><a class="reference internal" href="#closing-a-market-position" id="id23">Closing a market position</a></li>
<li><a class="reference internal" href="#oca-groups" id="id24">OCA groups</a><ul>
<li><a class="reference internal" href="#strategy-oca-cancel" id="id25">`strategy.oca.cancel`</a></li>
<li><a class="reference internal" href="#strategy-oca-reduce" id="id26">`strategy.oca.reduce`</a></li>
<li><a class="reference internal" href="#strategy-oca-none" id="id27">`strategy.oca.none`</a></li>
</ul>
</li>
<li><a class="reference internal" href="#currency" id="id28">Currency</a></li>
<li><a class="reference internal" href="#altering-calculation-behavior" id="id29">Altering calculation behavior</a><ul>
<li><a class="reference internal" href="#calc-on-every-tick" id="id30">`calc_on_every_tick`</a></li>
<li><a class="reference internal" href="#calc-on-order-fills" id="id31">`calc_on_order_fills`</a></li>
<li><a class="reference internal" href="#process-orders-on-close" id="id32">`process_orders_on_close`</a></li>
</ul>
</li>
<li><a class="reference internal" href="#simulating-trading-costs" id="id33">Simulating trading costs</a><ul>
<li><a class="reference internal" href="#commission" id="id34">Commission</a></li>
<li><a class="reference internal" href="#slippage-and-unfilled-limits" id="id35">Slippage and unfilled limits</a></li>
</ul>
</li>
<li><a class="reference internal" href="#risk-management" id="id36">Risk management</a></li>
<li><a class="reference internal" href="#margin" id="id37">Margin</a></li>
<li><a class="reference internal" href="#strategy-alerts" id="id38">Strategy Alerts</a></li>
<li><a class="reference internal" href="#notes-on-testing-strategies" id="id39">Notes on testing strategies</a><ul>
<li><a class="reference internal" href="#backtesting-and-forward-testing" id="id40">Backtesting and forward testing</a></li>
<li><a class="reference internal" href="#lookahead-bias" id="id41">Lookahead bias</a></li>
<li><a class="reference internal" href="#selection-bias" id="id42">Selection bias</a></li>
<li><a class="reference internal" href="#overfitting" id="id43">Overfitting</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id1">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Pine Script<sup>®</sup> strategies simulate the execution of trades on historical and real-time
data to facilitate the backtesting and forward testing of trading systems. They include
many of the same capabilities as Pine Script<sup>®</sup> indicators while providing the ability to
place, modify, and cancel hypothetical orders and analyze the results.</p>
<p>When a script uses the
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy">strategy()</a>
function for its declaration, it gains access to the <code class="docutils literal notranslate"><span class="pre">strategy.*</span></code> namespace, where
it can call functions and variables for simulating orders and accessing essential
strategy information. Additionally, the script will display information and simulated
results externally in the “Strategy Tester” tab.</p>
</div>
<div class="section" id="a-simple-strategy-example">
<span id="pagestrategies-asimplestrategyexample"></span><h2><a class="toc-backref" href="#id2">A simple strategy example</a><a class="headerlink" href="#a-simple-strategy-example" title="Permalink to this headline">¶</a></h2>
<p>The following script is a simple strategy that simulates the entry of long or short
positions upon the crossing of two moving averages:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;test&quot;, overlay = true)

// Calculate two moving averages with different lengths.
float fastMA = ta.sma(close, 14)
float slowMA = ta.sma(close, 28)

// Enter a long position when `fastMA` crosses over `slowMA`.
if ta.crossover(fastMA, slowMA)
    strategy.entry(&quot;buy&quot;, strategy.long)

// Enter a short position when `fastMA` crosses under `slowMA`.
if ta.crossunder(fastMA, slowMA)
    strategy.entry(&quot;sell&quot;, strategy.short)

// Plot the moving averages.
plot(fastMA, &quot;Fast MA&quot;, color.aqua)
plot(slowMA, &quot;Slow MA&quot;, color.orange)
</pre></div>
</div>
<dl class="docutils">
<dt>Note that:</dt>
<dd><ul class="first last simple">
<li>The <code class="docutils literal notranslate"><span class="pre">strategy(&quot;test&quot;</span> <span class="pre">overlay</span> <span class="pre">=</span> <span class="pre">true)</span></code> line declares that the script is a strategy
named “test” with visual outputs overlaid on the main chart pane.</li>
<li><a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}entry">strategy.entry()</a>
is the command that the script uses to simulate “buy” and “sell” orders. When the script places an
order, it also plots the order <code class="docutils literal notranslate"><span class="pre">id</span></code> on the chart and an arrow to indicate the direction.</li>
<li>Two <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_plot">plot()</a> functions
plot the moving averages with two different colors for visual reference.</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="applying-a-strategy-to-a-chart">
<span id="pagestrategies-applyingastrategytoachart"></span><h2><a class="toc-backref" href="#id3">Applying a strategy to a chart</a><a class="headerlink" href="#applying-a-strategy-to-a-chart" title="Permalink to this headline">¶</a></h2>
<p>To test a strategy, apply it to the chart. You can use a built-in strategy from the
“Indicators &amp; Strategies” dialog box or write your own in the Pine Editor. Click
“Add to chart” from the “Pine Editor” tab to apply a script to the chart:</p>
<img alt="../_images/Strategies-Applying-a-strategy-to-a-chart-1.png" src="../_images/Strategies-Applying-a-strategy-to-a-chart-1.png" />
<p>After a strategy script is compiled and applied to a chart, it will plot order marks
on the main chart pane and display simulated performance results in the
“Strategy Tester” tab below:</p>
<img alt="../_images/Strategies-Applying-a-strategy-to-a-chart-2.png" src="../_images/Strategies-Applying-a-strategy-to-a-chart-2.png" />
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The results from a strategy applied to non-standard charts
(<a class="reference external" href="https://www.tradingview.com/support/solutions/43000619436">Heikin Ashi</a>,
<a class="reference external" href="https://www.tradingview.com/support/solutions/43000502284">Renko</a>,
<a class="reference external" href="https://www.tradingview.com/support/solutions/43000502273">Line Break</a>,
<a class="reference external" href="https://www.tradingview.com/support/solutions/43000502272">Kagi</a>,
<a class="reference external" href="https://www.tradingview.com/support/solutions/43000502276">Point &amp; Figure</a>,
and <a class="reference external" href="https://www.tradingview.com/support/solutions/43000474007">Range</a>)
do not reflect actual market conditions by default. Strategy scripts will use the
synthetic price values from these charts during simulation, which often do not align
with actual market prices and will thus produce unrealistic backtest results. We
therefore highly recommend using standard chart types for backtesting strategies.
Alternatively, on Heikin Ashi charts, users can simulate orders using actual prices by
enabling the “Fill orders using standard OHLC” option in the
<a class="reference external" href="https://www.tradingview.com/support/solutions/43000628599">Strategy properties</a>
or by using <code class="docutils literal notranslate"><span class="pre">fill_orders_on_standard_ohlc</span> <span class="pre">=</span> <span class="pre">true</span></code> in the
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy">strategy()</a>
function call.</p>
</div>
</div>
<div class="section" id="strategy-tester">
<span id="pagestrategies-strategytester"></span><h2><a class="toc-backref" href="#id4">Strategy tester</a><a class="headerlink" href="#strategy-tester" title="Permalink to this headline">¶</a></h2>
<p>The Strategy Tester module is available to all scripts declared with the
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy">strategy()</a>
function. Users can access this module from the “Strategy Tester” tab below their
charts, where they can conveniently visualize their strategies and analyze
hypothetical performance results.</p>
<div class="section" id="overview">
<span id="pagestrategies-strategytester-overview"></span><h3><a class="toc-backref" href="#id5">Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference external" href="https://www.tradingview.com/support/solutions/43000681733">Overview</a> tab of the
Strategy Tester presents essential performance metrics and equity and drawdown
curves over a simulated sequence of trades, providing a quick look at strategy
performance without diving into granular detail. The chart in this section shows
the strategy’s <a class="reference external" href="https://www.tradingview.com/support/solutions/43000681735">equity curve</a>
as a baseline plot centered at the initial value, the
<a class="reference external" href="https://www.tradingview.com/support/solutions/43000681736">buy and hold equity curve</a> as a
line plot, and the <a class="reference external" href="https://www.tradingview.com/support/solutions/43000681734">drawdown curve</a>
as a histogram plot. Users can toggle these plots and scale them as absolute values or
percentages using the options below the chart.</p>
<img alt="../_images/Strategies-Strategy-tester-Overview-1.png" src="../_images/Strategies-Strategy-tester-Overview-1.png" />
<dl class="docutils">
<dt>Note that:</dt>
<dd><ul class="first last simple">
<li>The overview chart uses two scales; the left is for the equity curves, and the right
is for the drawdown curve.</li>
<li>When a user clicks a point on these plots, this will direct the main chart view to
the point where the trade was closed.</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="performance-summary">
<span id="pagestrategies-strategytester-performancesummary"></span><h3><a class="toc-backref" href="#id6">Performance summary</a><a class="headerlink" href="#performance-summary" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference external" href="https://www.tradingview.com/support/solutions/43000681683">Performance Summary</a> tab
of the module presents a comprehensive overview of a strategy’s performance metrics.
It displays three columns: one for all trades, one for all longs, and one for all shorts,
to provide traders with more detailed insights on a strategy’s long, short, and overall
simulated trading performance.</p>
<img alt="../_images/Strategies-Strategy-tester-Performance-summary-1.png" src="../_images/Strategies-Strategy-tester-Performance-summary-1.png" />
</div>
<div class="section" id="list-of-trades">
<span id="pagestrategies-strategytester-listoftrades"></span><h3><a class="toc-backref" href="#id7">List of trades</a><a class="headerlink" href="#list-of-trades" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference external" href="https://www.tradingview.com/support/solutions/43000681737">List of Trades</a> tab provides
a granular look at the trades simulated by a strategy with essential information,
including the date and time of execution, the type of order used (entry or exit), the number
of contracts/shares/lots/units traded, and the price, as well as some key trade performance metrics.</p>
<img alt="../_images/Strategies-Strategy-tester-List-of-trades-1.png" src="../_images/Strategies-Strategy-tester-List-of-trades-1.png" />
<dl class="docutils">
<dt>Note that:</dt>
<dd><ul class="first last simple">
<li>Users can navigate the times of specific trades on their charts by clicking on them in this list.</li>
<li>By clicking the “Trade #” field above the list, users can organize the trades in ascending order
starting from the first or descending order starting from the last.</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="properties">
<span id="pagestrategies-strategytester-properties"></span><h3><a class="toc-backref" href="#id8">Properties</a><a class="headerlink" href="#properties" title="Permalink to this headline">¶</a></h3>
<p>The Properties tab provides detailed information about a strategy’s configuration and the
dataset to which it is applied. It includes the strategy’s date range, symbol information,
script settings, and strategy properties.</p>
<ul class="simple">
<li><strong>Date Range</strong> - Includes the range of dates with simulated trades and the total available backtesting range.</li>
<li><strong>Symbol Info</strong> - Contains the symbol name and broker/exchange, the chart’s timeframe and type, the tick size, the point value for the chart, and the base currency.</li>
<li><strong>Strategy Inputs</strong> - Outlines the various parameters and variables used in the strategy script available in the “Inputs” tab of the script settings.</li>
<li><strong>Strategy Properties</strong> - Provides an overview of the configuration of the trading strategy. It includes essential details such as the initial capital, base currency, order size, margin, pyramiding, commission, and slippage. Additionally, this section highlights any modifications made to strategy calculation behavior.</li>
</ul>
<img alt="../_images/Strategies-Strategy-tester-Properties-1.png" src="../_images/Strategies-Strategy-tester-Properties-1.png" />
</div>
</div>
<div class="section" id="broker-emulator">
<span id="pagestrategies-brokeremulator"></span><h2><a class="toc-backref" href="#id9">Broker emulator</a><a class="headerlink" href="#broker-emulator" title="Permalink to this headline">¶</a></h2>
<p>TradingView utilizes a <em>broker emulator</em> to simulate the performance of trading strategies.
Unlike in real-life trading, the emulator strictly uses available chart prices for order
simulation. Consequently, the simulation can only place historical trades after a bar closes,
and it can only place real-time trades on a new price tick. For more information on this
behavior, please refer to the Pine Script<sup>®</sup> <a class="reference internal" href="../language/Execution_model.html#pageexecutionmodel"><span class="std std-ref">Execution model</span></a>.</p>
<p>Since the emulator can only use chart data, it makes assumptions about intrabar price movement.
It uses a bar’s open, high, and low prices to infer intrabar activity while calculating order
fills with the following logic:</p>
<ul class="simple">
<li>If the high price is closer to the opening price than the low price, it assumes that the price moved in this order on the bar: open → high → low → close.</li>
<li>If the low price is closer to the opening price than the high price, it assumes that the price moved in this order on the bar: open → low → high → close.</li>
<li>The broker emulator assumes no gaps exist between prices within bars; in the “eyes” of the emulator, the full range of intrabar prices is available for order execution.</li>
</ul>
<img alt="../_images/Strategies-Broker-emulator-1.png" src="../_images/Strategies-Broker-emulator-1.png" />
<div class="section" id="bar-magnifier">
<span id="pagebrokeremulator-barmagnifier"></span><h3><a class="toc-backref" href="#id10">Bar magnifier</a><a class="headerlink" href="#bar-magnifier" title="Permalink to this headline">¶</a></h3>
<p>Premium account holders can override the broker emulator’s intrabar assumptions via the
<code class="docutils literal notranslate"><span class="pre">use_bar_magnifier</span></code> parameter of the
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy">strategy()</a>
function or the “Use bar magnifier” input in the “Properties” tab of the script settings.
The <a class="reference external" href="https://www.tradingview.com/support/solutions/43000669285">Bar Magnifier</a> inspects data
on timeframes smaller than the chart’s to obtain more granular information about price
action within a bar, thus allowing more precise order fills during simulation.</p>
<p>To demonstrate, the following script places a “Buy” limit order at the <code class="docutils literal notranslate"><span class="pre">entryPrice</span></code>
and an “Exit” limit order at the <code class="docutils literal notranslate"><span class="pre">exitPrice</span></code> when the
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#var_time">time</a> value
crosses the <code class="docutils literal notranslate"><span class="pre">orderTime</span></code>, and draws two horizontal lines to visualize the order prices.
The script also highlights the background using the <code class="docutils literal notranslate"><span class="pre">orderColor</span></code> to indicate when
the strategy placed the orders:</p>
<img alt="../_images/Strategies-Broker-emulator-Bar-magnifier-1.png" src="../_images/Strategies-Broker-emulator-Bar-magnifier-1.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;Bar Magnifier Demo&quot;, overlay = true, use_bar_magnifier = false)

//@variable The UNIX timestamp to place the order at.
int orderTime = timestamp(&quot;UTC&quot;, 2023, 3, 22, 18)

//@variable Returns `color.orange` when `time` crosses the `orderTime`, false otherwise.
color orderColor = na

// Entry and exit prices.
float entryPrice = hl2 - (high - low)
float exitPrice  = entryPrice + (high - low) * 0.25

// Entry and exit lines.
var line entryLine = na
var line exitLine  = na

if ta.cross(time, orderTime)
    // Draw new entry and exit lines.
    entryLine := line.new(bar_index, entryPrice, bar_index + 1, entryPrice, color = color.green, width = 2)
    exitLine  := line.new(bar_index, exitPrice, bar_index + 1, exitPrice, color = color.red, width = 2)

    // Update order highlight color.
    orderColor := color.new(color.orange, 80)

    // Place limit orders at the `entryPrice` and `exitPrice`.
    strategy.entry(&quot;Buy&quot;, strategy.long, limit = entryPrice)
    strategy.exit(&quot;Exit&quot;, &quot;Buy&quot;, limit = exitPrice)

// Update lines while the position is open.
else if strategy.position_size &gt; 0.0
    entryLine.set_x2(bar_index + 1)
    exitLine.set_x2(bar_index + 1)

bgcolor(orderColor)
</pre></div>
</div>
<p>As we see in the chart above, the broker emulator assumed that intrabar prices moved
from open to high, then high to low, then low to close on the bar the “Buy” order filled
on, meaning the emulator assumed that the “Exit” order couldn’t fill on the same bar.
However, after including <code class="docutils literal notranslate"><span class="pre">use_bar_magnifier</span> <span class="pre">=</span> <span class="pre">true</span></code> in the declaration statement,
we see a different story:</p>
<img alt="../_images/Strategies-Broker-emulator-Bar-magnifier-2.png" src="../_images/Strategies-Broker-emulator-Bar-magnifier-2.png" />
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The maximum amount of intrabars that a script can request is 100,000.
Some symbols with lengthier history may not have full intrabar coverage
for their beginning chart bars with this limitation, meaning that simulated
trades on those bars will not be affected by the bar magnifier.</p>
</div>
</div>
</div>
<div class="section" id="orders-and-entries">
<span id="pagestrategies-ordersandentries"></span><h2><a class="toc-backref" href="#id11">Orders and entries</a><a class="headerlink" href="#orders-and-entries" title="Permalink to this headline">¶</a></h2>
<p>Just like in real-life trading, Pine strategies use orders to manage positions. In this
context, an <em>order</em> is a command to simulate a market action, and a <em>trade</em> is the result
after the order fills. Thus, to enter or exit positions using Pine, users must create
orders with parameters that specify how they’ll behave.</p>
<p>To take a closer look at how orders work and how they become trades, let’s write a simple
strategy script:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;My strategy&quot;, overlay = true, margin_long = 100, margin_short = 100)

//@function Displays text passed to `txt` when called.
debugLabel(txt) =&gt;
    label.new(
         bar_index, high, text = txt, color=color.lime, style = label.style_label_lower_right,
         textcolor = color.black, size = size.large
     )

longCondition = bar_index % 20 == 0 // true on every 20th bar
if (longCondition)
    debugLabel(&quot;Long entry order created&quot;)
    strategy.entry(&quot;My Long Entry Id&quot;, strategy.long)
strategy.close_all()
</pre></div>
</div>
<p>In this script, we’ve defined a <code class="docutils literal notranslate"><span class="pre">longCondition</span></code> that is true whenever the <code class="docutils literal notranslate"><span class="pre">bar_index</span></code> is
divisible by 20, i.e., every 20th bar. The strategy uses this condition within an
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#op_if">if</a> structure to simulate an entry order with
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}entry">strategy.entry()</a>
and draws a label at the entry price with the user-defined <code class="docutils literal notranslate"><span class="pre">debugLabel()</span></code> function. The script calls
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}close_all">strategy.close_all()</a>
from the global scope to simulate a market order that closes any open position.
Let’s see what happens once we add the script to our chart:</p>
<img alt="../_images/Strategies-Orders-and-entries-1.png" src="../_images/Strategies-Orders-and-entries-1.png" />
<p>The blue arrows on the chart indicate entry locations, and the purple ones mark the points where
the strategy closed positions. Notice that the labels precede the actual entry point rather than
occurring on the same bar - this is orders in action. By default, Pine strategies wait for the
next available price tick before filling orders, as filling an order on the same tick isn’t realistic.
Also, they recalculate on the close of every historical bar, meaning the next available tick to
fill an order at is the open of the next bar in this case. As a result, by default, all orders are
delayed by one chart bar.</p>
<p>It’s important to note that although the script calls
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}close_all">strategy.close_all()</a>
from the global scope, forcing execution on every bar, the function call does nothing if the strategy
isn’t simulating an open position. If there is an open position, the command issues a market order to
close it, which executes on the next available tick. For example, when the <code class="docutils literal notranslate"><span class="pre">longCondition</span></code> is true
on bar 20, the strategy places an entry order to fill at the next tick, which is at the open of bar 21.
Once the script recalculates its values on that bar’s close, the function places an order to close the
position, which fills at the open of bar 22.</p>
<div class="section" id="order-types">
<span id="pagestrategies-ordersandentries-ordertypes"></span><h3><a class="toc-backref" href="#id12">Order types</a><a class="headerlink" href="#order-types" title="Permalink to this headline">¶</a></h3>
<p>Pine Script<sup>®</sup> strategies allow users to simulate different order types for their particular needs.
The main notable types are <em>market</em>, <em>limit</em>, <em>stop</em>, and <em>stop-limit</em>.</p>
<div class="section" id="market-orders">
<span id="pagestrategies-ordersandentries-ordertypes-marketorders"></span><h4><a class="toc-backref" href="#id13">Market orders</a><a class="headerlink" href="#market-orders" title="Permalink to this headline">¶</a></h4>
<p>Market orders are the most basic type of orders. They command a strategy to buy or sell a security
as soon as possible, regardless of the price. Consequently, they always execute on the next available
price tick. By default, all <code class="docutils literal notranslate"><span class="pre">strategy.*()</span></code> functions that generate orders specifically produce market orders.</p>
<p>The following script simulates a long market order when the <code class="docutils literal notranslate"><span class="pre">bar_index</span></code> is divisible by <code class="docutils literal notranslate"><span class="pre">2</span> <span class="pre">*</span> <span class="pre">cycleLength</span></code>.
Otherwise, it simulates a short market order when the <code class="docutils literal notranslate"><span class="pre">bar_index</span></code> is divisible by <code class="docutils literal notranslate"><span class="pre">cycleLength</span></code>,
resulting in a strategy with alternating long and short trades once every <code class="docutils literal notranslate"><span class="pre">cycleLength</span></code> bars:</p>
<img alt="../_images/Strategies-Orders-and-entries-Order-types-1.png" src="../_images/Strategies-Orders-and-entries-Order-types-1.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;Market order demo&quot;, overlay = true, margin_long = 100, margin_short = 100)

//@variable Number of bars between long and short entries.
cycleLength = input.int(10, &quot;Cycle length&quot;)

//@function Displays text passed to `txt` when called.
debugLabel(txt, lblColor) =&gt; label.new(
     bar_index, high, text = txt, color = lblColor, textcolor = color.white,
     style = label.style_label_lower_right, size = size.large
 )

//@variable Returns `true` every `2 * cycleLength` bars.
longCondition = bar_index % (2 * cycleLength) == 0
//@variable Returns `true` every `cycleLength` bars.
shortCondition = bar_index % cycleLength == 0

// Generate a long market order with a `color.green` label on `longCondition`.
if longCondition
    debugLabel(&quot;Long market order created&quot;, color.green)
    strategy.entry(&quot;My Long Entry Id&quot;, strategy.long)
// Otherwise, generate a short market order with a `color.red` label on `shortCondition`.
else if shortCondition
    debugLabel(&quot;Short market order created&quot;, color.red)
    strategy.entry(&quot;My Short Entry Id&quot;, strategy.short)
</pre></div>
</div>
</div>
<div class="section" id="limit-orders">
<span id="pagestrategies-ordersandentries-ordertypes-limitorders"></span><h4><a class="toc-backref" href="#id14">Limit orders</a><a class="headerlink" href="#limit-orders" title="Permalink to this headline">¶</a></h4>
<p>Limit orders command a strategy to enter a position at a specific price or better (lower than specified for long
orders and higher for short ones). When the current market price is better than the order command’s <code class="docutils literal notranslate"><span class="pre">limit</span></code>
parameter, the order will fill without waiting for the market price to reach the limit level.</p>
<p>To simulate limit orders in a script, pass a price value to an order placement command with a <code class="docutils literal notranslate"><span class="pre">limit</span></code> parameter.
The following example places a limit order 800 ticks below the bar close 100 bars before the <code class="docutils literal notranslate"><span class="pre">last_bar_index</span></code>:</p>
<img alt="../_images/Strategies-Orders-and-entries-Order-types-2.png" src="../_images/Strategies-Orders-and-entries-Order-types-2.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;Limit order demo&quot;, overlay = true, margin_long = 100, margin_short = 100)

//@function Displays text passed to `txt` and a horizontal line at `price` when called.
debugLabel(price, txt) =&gt;
    label.new(
         bar_index, price, text = txt, color = color.teal, textcolor = color.white,
         style = label.style_label_lower_right, size = size.large
     )
    line.new(
         bar_index, price, bar_index + 1, price, color = color.teal, extend = extend.right,
         style = line.style_dashed
     )

// Generate a long limit order with a label and line 100 bars before the `last_bar_index`.
if last_bar_index - bar_index == 100
    limitPrice = close - syminfo.mintick * 800
    debugLabel(limitPrice, &quot;Long Limit order created&quot;)
    strategy.entry(&quot;Long&quot;, strategy.long, limit = limitPrice)
</pre></div>
</div>
<p>Note how the script placed the label and started the line several bars before the trade. As long as the price remained
above the <code class="docutils literal notranslate"><span class="pre">limitPrice</span></code> value, the order could not fill. Once the market price reached the limit, the strategy executed
the trade mid-bar. If we had set the <code class="docutils literal notranslate"><span class="pre">limitPrice</span></code> to 800 ticks <em>above</em> the bar close rather than <em>below</em>, the order would
fill immediately since the price is already at a better value:</p>
<img alt="../_images/Strategies-Orders-and-entries-Order-types-3.png" src="../_images/Strategies-Orders-and-entries-Order-types-3.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;Limit order demo&quot;, overlay = true, margin_long = 100, margin_short = 100)

//@function Displays text passed to `txt` and a horizontal line at `price` when called.
debugLabel(price, txt) =&gt;
    label.new(
         bar_index, price, text = txt, color = color.teal, textcolor = color.white,
         style = label.style_label_lower_right, size = size.large
     )
    line.new(
         bar_index, price, bar_index + 1, price, color = color.teal, extend = extend.right,
         style = line.style_dashed
     )

// Generate a long limit order with a label and line 100 bars before the `last_bar_index`.
if last_bar_index - bar_index == 100
    limitPrice = close + syminfo.mintick * 800
    debugLabel(limitPrice, &quot;Long Limit order created&quot;)
    strategy.entry(&quot;Long&quot;, strategy.long, limit = limitPrice)
</pre></div>
</div>
</div>
<div class="section" id="stop-and-stop-limit-orders">
<span id="pagestrategies-ordersandentries-ordertypes-stopandstoplimitorders"></span><h4><a class="toc-backref" href="#id15">Stop and stop-limit orders</a><a class="headerlink" href="#stop-and-stop-limit-orders" title="Permalink to this headline">¶</a></h4>
<p>Stop orders command a strategy to simulate another order after price reaches the specified <code class="docutils literal notranslate"><span class="pre">stop</span></code> price or a worse
value (higher than specified for long orders and lower for short ones). They are essentially the opposite of limit
orders. When the current market price is worse than the <code class="docutils literal notranslate"><span class="pre">stop</span></code> parameter, the strategy will trigger the subsequent
order without waiting for the current price to reach the stop level. If the order placement command includes a <code class="docutils literal notranslate"><span class="pre">limit</span></code>
argument, the subsequent order will be a limit order at the specified value. Otherwise, it will be a market order.</p>
<p>The script below places a stop order 800 ticks above the <code class="docutils literal notranslate"><span class="pre">close</span></code> 100 bars ago. In this example, the strategy entered
a long position when the market price crossed the <code class="docutils literal notranslate"><span class="pre">stop</span></code> price some bars after it placed the order. Notice that the
initial price at the time of the order was better than the one passed to <code class="docutils literal notranslate"><span class="pre">stop</span></code>. An equivalent limit order would have filled
on the following chart bar:</p>
<img alt="../_images/Strategies-Orders-and-entries-Order-types-4.png" src="../_images/Strategies-Orders-and-entries-Order-types-4.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;Stop order demo&quot;, overlay = true, margin_long = 100, margin_short = 100)

//@function Displays text passed to `txt` when called and shows the `price` level on the chart.
debugLabel(price, txt) =&gt;
    label.new(
         bar_index, high, text = txt, color = color.teal, textcolor = color.white,
         style = label.style_label_lower_right, size = size.large
     )
    line.new(bar_index, high, bar_index, price, style = line.style_dotted, color = color.teal)
    line.new(
         bar_index, price, bar_index + 1, price, color = color.teal, extend = extend.right,
         style = line.style_dashed
     )

// Generate a long stop order with a label and lines 100 bars before the last bar.
if last_bar_index - bar_index == 100
    stopPrice = close + syminfo.mintick * 800
    debugLabel(stopPrice, &quot;Long Stop order created&quot;)
    strategy.entry(&quot;Long&quot;, strategy.long, stop = stopPrice)
</pre></div>
</div>
<p>Order placement commands that use both <code class="docutils literal notranslate"><span class="pre">limit</span></code> and <code class="docutils literal notranslate"><span class="pre">stop</span></code> arguments produce stop-limit orders. This order type
waits for the price to cross the stop level, then places a limit order at the specified <code class="docutils literal notranslate"><span class="pre">limit</span></code> price.</p>
<p>Let’s modify our previous script to simulate and visualize a stop-limit order. In this example, we use the <code class="docutils literal notranslate"><span class="pre">low</span></code> value
from 100 bars ago as the <code class="docutils literal notranslate"><span class="pre">limit</span></code> price in the entry command. This script also displays a label and price level to indicate
when the strategy crosses the <code class="docutils literal notranslate"><span class="pre">stopPrice</span></code>, i.e., when the strategy activates the limit order. Notice how the market
price initially reaches the limit level, but the strategy doesn’t simulate a trade because the price must cross the
<code class="docutils literal notranslate"><span class="pre">stopPrice</span></code> to place the pending limit order at the <code class="docutils literal notranslate"><span class="pre">limitPrice</span></code>:</p>
<img alt="../_images/Strategies-Orders-and-entries-Order-types-5.png" src="../_images/Strategies-Orders-and-entries-Order-types-5.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;Stop-Limit order demo&quot;, overlay = true, margin_long = 100, margin_short = 100)

//@function Displays text passed to `txt` when called and shows the `price` level on the chart.
debugLabel(price, txt, lblColor, lineWidth = 1) =&gt;
    label.new(
         bar_index, high, text = txt, color = lblColor, textcolor = color.white,
         style = label.style_label_lower_right, size = size.large
     )
    line.new(bar_index, close, bar_index, price, style = line.style_dotted, color = lblColor, width = lineWidth)
    line.new(
         bar_index, price, bar_index + 1, price, color = lblColor, extend = extend.right,
         style = line.style_dashed, width = lineWidth
     )

var float stopPrice  = na
var float limitPrice = na

// Generate a long stop-limit order with a label and lines 100 bars before the last bar.
if last_bar_index - bar_index == 100
    stopPrice  := close + syminfo.mintick * 800
    limitPrice := low
    debugLabel(limitPrice, &quot;&quot;, color.gray)
    debugLabel(stopPrice, &quot;Long Stop-Limit order created&quot;, color.teal)
    strategy.entry(&quot;Long&quot;, strategy.long, stop = stopPrice, limit = limitPrice)

// Draw a line and label once the strategy activates the limit order.
if high &gt;= stopPrice
    debugLabel(limitPrice, &quot;Limit order activated&quot;, color.green, 2)
    stopPrice := na
</pre></div>
</div>
</div>
</div>
<div class="section" id="order-placement-commands">
<span id="pagestrategies-ordersandentries-orderplacementcommands"></span><h3><a class="toc-backref" href="#id16">Order placement commands</a><a class="headerlink" href="#order-placement-commands" title="Permalink to this headline">¶</a></h3>
<p>Pine Script<sup>®</sup> strategies feature several functions to simulate the placement of orders, known as <em>order placement
commands</em>. Each command serves a unique purpose and behaves differently from the others.</p>
<div class="section" id="strategy-entry">
<span id="pagestrategies-ordersandentries-orderplacementcommands-strategyentry"></span><h4><a class="toc-backref" href="#id17">`strategy.entry()`</a><a class="headerlink" href="#strategy-entry" title="Permalink to this headline">¶</a></h4>
<p>This command simulates entry orders. By default, strategies place market orders when calling this function, but they
can also create stop, limit, and stop-limit orders when utilizing the <code class="docutils literal notranslate"><span class="pre">stop</span></code> and <code class="docutils literal notranslate"><span class="pre">limit</span></code> parameters.</p>
<p>To simplify opening positions, <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}entry">strategy.entry()</a>
features several unique behaviors. One such behavior is that this command can reverse an open market position without additional
function calls. When an order placed using <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}entry">strategy.entry()</a>
fills, the function will automatically calculate the amount the strategy needs to close the open market position and trade <code class="docutils literal notranslate"><span class="pre">qty</span></code>
contracts/shares/lots/units in the opposite direction by default. For example, if a strategy has an open position of 15 shares in the
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#var_strategy{dot}long">strategy.long</a> direction and calls
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}entry">strategy.entry()</a> to place a market order in the
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#var_strategy{dot}short">strategy.short</a> direction, the amount the strategy will
trade to place the order is 15 shares plus the <code class="docutils literal notranslate"><span class="pre">qty</span></code> of the new short order.</p>
<p>The example below demonstrates a strategy that uses only <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}entry">strategy.entry()</a>
calls to place entry orders. It creates a long market order with a <code class="docutils literal notranslate"><span class="pre">qty</span></code> value of 15 shares once every 100 bars and a
short market order with a <code class="docutils literal notranslate"><span class="pre">qty</span></code> of 5 once every 25 bars. The script highlights the background blue and red for occurrences
of the respective <code class="docutils literal notranslate"><span class="pre">buyCondition</span></code> and <code class="docutils literal notranslate"><span class="pre">sellCondition</span></code>:</p>
<img alt="../_images/Strategies-Orders-and-entries-Order-placement-commands-1.png" src="../_images/Strategies-Orders-and-entries-Order-placement-commands-1.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;Entry demo&quot;, &quot;test&quot;, overlay = true)

//@variable Is `true` on every 100th bar.
buyCondition = bar_index % 100 == 0
//@variable Is `true` on every 25th bar except for those that are divisible by 100.
sellCondition = bar_index % 25 == 0 and not buyCondition

if buyCondition
    strategy.entry(&quot;buy&quot;, strategy.long, qty = 15)
if sellCondition
    strategy.entry(&quot;sell&quot;, strategy.short, qty = 5)

bgcolor(buyCondition  ? color.new(color.blue, 90) : na)
bgcolor(sellCondition ? color.new(color.red, 90) : na)
</pre></div>
</div>
<p>As we see in the chart above, the order marks show that the strategy traded 20 shares on each order fill
rather than 15 and 5. Since <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}entry">strategy.entry()</a>
automatically reverses positions, unless otherwise specified via the
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}risk{dot}allow_entry_in">strategy.risk.allow_entry_in()</a>
function, it adds the open position size (15 for long entries) to the new order’s size (5 for short entries) when it changes
the direction, resulting in a traded quantity of 20 shares.</p>
<p>Notice that in the above example, although the <code class="docutils literal notranslate"><span class="pre">sellCondition</span></code> occurs three times before another <code class="docutils literal notranslate"><span class="pre">buyCondition</span></code>,
the strategy only places a “sell” order on the first occurrence. Another unique behavior of the
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}entry">strategy.entry()</a> command is that it’s
affected by a script’s <em>pyramiding</em> setting. Pyramiding specifies the number of consecutive orders the strategy can fill
in the same direction. Its value is 1 by default, meaning the strategy only allows one consecutive order to fill in either
direction. Users can set the strategy pyramiding values via the <code class="docutils literal notranslate"><span class="pre">pyramiding</span></code> parameter of the
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy">strategy()</a> function call or the “Pyramiding”
input in the “Properties” tab of the script settings.</p>
<p>If we add <code class="docutils literal notranslate"><span class="pre">pyramiding</span> <span class="pre">=</span> <span class="pre">3</span></code> to our previous script’s declaration statement, the strategy will allow up to three consecutive trades
in the same direction, meaning it can simulate new market orders on each occurrence of <code class="docutils literal notranslate"><span class="pre">sellCondition</span></code>:</p>
<img alt="../_images/Strategies-Orders-and-entries-Order-placement-commands-2.png" src="../_images/Strategies-Orders-and-entries-Order-placement-commands-2.png" />
</div>
<div class="section" id="strategy-order">
<span id="pagestrategies-ordersandentries-orderplacementcommands-strategyorder"></span><h4><a class="toc-backref" href="#id18">`strategy.order()`</a><a class="headerlink" href="#strategy-order" title="Permalink to this headline">¶</a></h4>
<p>This command simulates a basic order. Unlike most order placement commands, which contain internal logic to simplify interfacing with
strategies, <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}order">strategy.order()</a> uses the specified
parameters without accounting for most additional strategy settings. Orders placed by
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}order">strategy.order()</a> can open new positions and modify
or close existing ones.</p>
<p>The following script uses only <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}order">strategy.order()</a> calls
to create and modify entries. The strategy simulates a long market order for 15 units every 100 bars, then three short orders for five units
every 25 bars. The script highlights the background blue and red to indicate when the strategy simulates “buy” and “sell” orders:</p>
<img alt="../_images/Strategies-Orders-and-entries-Order-placement-commands-3.png" src="../_images/Strategies-Orders-and-entries-Order-placement-commands-3.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;Order demo&quot;, &quot;test&quot;, overlay = true)

//@variable Is `true` on every 100th bar.
buyCond = bar_index % 100 == 0
//@variable Is `true` on every 25th bar except for those that are divisible by 100.
sellCond = bar_index % 25 == 0 and not buyCond

if buyCond
    strategy.order(&quot;buy&quot;, strategy.long, qty = 15) // Enter a long position of 15 units.
if sellCond
    strategy.order(&quot;sell&quot;, strategy.short, qty = 5) // Exit 5 units from the long position.

bgcolor(buyCond  ? color.new(color.blue, 90) : na)
bgcolor(sellCond ? color.new(color.red, 90) : na)
</pre></div>
</div>
<p>This particular strategy will never simulate a short position, as unlike
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}entry">strategy.entry()</a>,
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}order">strategy.order()</a>
does not automatically reverse positions. When using this command, the resulting market position is the net
sum of the current market position and the filled order quantity. After the strategy fills the “buy” order for
15 units, it executes three “sell” orders that reduce the open position by five units each, and 15 - 5 * 3 = 0.
The same script would behave differently using
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}entry">strategy.entry()</a>, as per the
example shown in the <a class="reference internal" href="#pagestrategies-ordersandentries-orderplacementcommands-strategyentry"><span class="std std-ref">section above</span></a>.</p>
</div>
<div class="section" id="strategy-exit">
<span id="pagestrategies-ordersandentries-orderplacementcommands-strategyexit"></span><h4><a class="toc-backref" href="#id19">`strategy.exit()`</a><a class="headerlink" href="#strategy-exit" title="Permalink to this headline">¶</a></h4>
<p>This command simulates exit orders. It’s unique in that it allows a strategy to exit a market position or
form multiple exits in the form of stop-loss, take-profit, and trailing stop orders via the <code class="docutils literal notranslate"><span class="pre">loss</span></code>, <code class="docutils literal notranslate"><span class="pre">stop</span></code>,
<code class="docutils literal notranslate"><span class="pre">profit</span></code>, <code class="docutils literal notranslate"><span class="pre">limit</span></code>, and <code class="docutils literal notranslate"><span class="pre">trail_*</span></code> parameters.</p>
<p>The most basic use of the <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}exit">strategy.exit()</a>
command is the creation of levels where the strategy will exit a position due to losing too much money (stop-loss), earning
enough money (take-profit), or both (bracket).</p>
<p>The stop-loss and take-profit functionalities of this command are associated with two parameters. The function’s <code class="docutils literal notranslate"><span class="pre">loss</span></code> and <code class="docutils literal notranslate"><span class="pre">profit</span></code>
parameters specify stop-loss and take-profit values as a defined number of ticks away from the entry order’s price, while its <code class="docutils literal notranslate"><span class="pre">stop</span></code> and <code class="docutils literal notranslate"><span class="pre">limit</span></code>
parameters provide specific stop-loss and take-profit price values. The absolute parameters in the function call supersede the relative ones.
If a <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}exit">strategy.exit()</a>  call contains <code class="docutils literal notranslate"><span class="pre">profit</span></code> and <code class="docutils literal notranslate"><span class="pre">limit</span></code> arguments,
the command will prioritize the <code class="docutils literal notranslate"><span class="pre">limit</span></code> value and ignore the <code class="docutils literal notranslate"><span class="pre">profit</span></code> value. Likewise, it will only consider the <code class="docutils literal notranslate"><span class="pre">stop</span></code> value when the function call
contains <code class="docutils literal notranslate"><span class="pre">stop</span></code> and <code class="docutils literal notranslate"><span class="pre">loss</span></code> arguments.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Despite sharing the same names with parameters from <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}entry">strategy.entry()</a>
and <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}order">strategy.order()</a> commands, the <code class="docutils literal notranslate"><span class="pre">limit</span></code>
and <code class="docutils literal notranslate"><span class="pre">stop</span></code> parameters work differently in <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}exit">strategy.exit()</a>.
In the first case, using <code class="docutils literal notranslate"><span class="pre">limit</span></code> and <code class="docutils literal notranslate"><span class="pre">stop</span></code> in the command will create a single stop-limit order that opens a limit order after
crossing the stop price. In the second case, the command will create a separate limit and stop order to exit from an open position.</p>
</div>
<p>All exit orders from <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}exit">strategy.exit()</a>
with a <code class="docutils literal notranslate"><span class="pre">from_entry</span></code> argument are bound to the <code class="docutils literal notranslate"><span class="pre">id</span></code> of a corresponding entry order; strategies cannot simulate exit
orders when there is no open market position or active entry order associated with a <code class="docutils literal notranslate"><span class="pre">from_entry</span></code> ID.</p>
<p>The following strategy places a “buy” entry order via <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}entry">strategy.entry()</a>
and a stop-loss and take-profit order via the <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}exit">strategy.exit()</a>
command every 100 bars. Notice that the script calls <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}exit">strategy.exit()</a>
twice. The “exit1” command references a “buy1” entry order, and “exit2” references the “buy” order. The strategy will only simulate exit orders from
“exit2” because “exit1” references an order ID that doesn’t exist:</p>
<img alt="../_images/Strategies-Orders-and-entries-Order-placement-commands-4.png" src="../_images/Strategies-Orders-and-entries-Order-placement-commands-4.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;Exit demo&quot;, &quot;test&quot;, overlay = true)

//@variable Is `true` on every 100th bar.
buyCondition = bar_index % 100 == 0

//@variable Stop-loss price for exit commands.
var float stopLoss   = na
//@variable Take-profit price for exit commands.
var float takeProfit = na

// Place orders upon `buyCondition`.
if buyCondition
    if strategy.position_size == 0.0
        stopLoss   := close * 0.99
        takeProfit := close * 1.01
    strategy.entry(&quot;buy&quot;, strategy.long)
    strategy.exit(&quot;exit1&quot;, &quot;buy1&quot;, stop = stopLoss, limit = takeProfit) // Does nothing. &quot;buy1&quot; order doesn&#39;t exist.
    strategy.exit(&quot;exit2&quot;, &quot;buy&quot;, stop = stopLoss, limit = takeProfit)

// Set `stopLoss` and `takeProfit` to `na` when price touches either, i.e., when the strategy simulates an exit.
if low &lt;= stopLoss or high &gt;= takeProfit
    stopLoss   := na
    takeProfit := na

plot(stopLoss, &quot;SL&quot;, color.red, style = plot.style_circles)
plot(takeProfit, &quot;TP&quot;, color.green, style = plot.style_circles)
</pre></div>
</div>
<dl class="docutils">
<dt>Note that:</dt>
<dd><ul class="first last simple">
<li>Limit and stop orders from each exit command do not necessarily fill at the specified prices. Strategies can fill limit
orders at better prices and stop orders at worse prices, depending on the range of values available to the broker emulator.</li>
</ul>
</dd>
</dl>
<p>If a user does not provide a <code class="docutils literal notranslate"><span class="pre">from_entry</span></code> argument in the <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}exit">strategy.exit()</a>
call, the function will create exit orders for each open entry.</p>
<p>In this example, the strategy creates “buy1” and “buy2” entry orders and calls
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}exit">strategy.exit()</a> without a <code class="docutils literal notranslate"><span class="pre">from_entry</span></code> argument
every 100 bars. As we can see from the order marks on the chart, once the market price reaches the <code class="docutils literal notranslate"><span class="pre">stopLoss</span></code> or <code class="docutils literal notranslate"><span class="pre">takeProfit</span></code>
values, the strategy fills an exit order for both “buy1” and “buy2” entries:</p>
<img alt="../_images/Strategies-Orders-and-entries-Order-placement-commands-4a.png" src="../_images/Strategies-Orders-and-entries-Order-placement-commands-4a.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;Exit all demo&quot;, &quot;test&quot;, overlay = true, pyramiding = 2)

//@variable Is `true` on every 100th bar.
buyCondition = bar_index % 100 == 0

//@variable Stop-loss price for exit commands.
var float stopLoss   = na
//@variable Take-profit price for exit commands.
var float takeProfit = na

// Place orders upon `buyCondition`.
if buyCondition
    if strategy.position_size == 0.0
        stopLoss   := close * 0.99
        takeProfit := close * 1.01
    strategy.entry(&quot;buy1&quot;, strategy.long)
    strategy.entry(&quot;buy2&quot;, strategy.long)
    strategy.exit(&quot;exit&quot;, stop = stopLoss, limit = takeProfit) // Places orders to exit all open entries.

// Set `stopLoss` and `takeProfit` to `na` when price touches either, i.e., when the strategy simulates an exit.
if low &lt;= stopLoss or high &gt;= takeProfit
    stopLoss   := na
    takeProfit := na

plot(stopLoss, &quot;SL&quot;, color.red, style = plot.style_circles)
plot(takeProfit, &quot;TP&quot;, color.green, style = plot.style_circles)
</pre></div>
</div>
<p>It is possible for a strategy to exit from the same entry ID more than once, which facilitates the formation of multi-level exit
strategies. When performing multiple exit commands, each order’s quantity must be a portion of the traded quantity, with their sum
not exceeding the open position. If the <code class="docutils literal notranslate"><span class="pre">qty</span></code> of the function is less than the size of the current market position, the strategy
will simulate a partial exit. If the <code class="docutils literal notranslate"><span class="pre">qty</span></code> value exceeds the open position quantity, it will reduce the order since it cannot fill
more contracts/shares/lots/units than the open position.</p>
<p>In the example below, we’ve modified our previous “Exit demo” script to simulate two stop-loss and take-profit orders per entry.
The strategy places a “buy” order with a <code class="docutils literal notranslate"><span class="pre">qty</span></code> of two shares, “exit1” stop-loss and take-profit orders with a <code class="docutils literal notranslate"><span class="pre">qty</span></code> of one share,
and “exit2” stop-loss and take profit orders with a <code class="docutils literal notranslate"><span class="pre">qty</span></code> of three shares:</p>
<img alt="../_images/Strategies-Orders-and-entries-Order-placement-commands-5.png" src="../_images/Strategies-Orders-and-entries-Order-placement-commands-5.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;Multiple exit demo&quot;, &quot;test&quot;, overlay = true)

//@variable Is `true` on every 100th bar.
buyCondition = bar_index % 100 == 0

//@variable Stop-loss price for &quot;exit1&quot; commands.
var float stopLoss1 = na
//@variable Stop-loss price for &quot;exit2&quot; commands.
var float stopLoss2 = na
//@variable Take-profit price for &quot;exit1&quot; commands.
var float takeProfit1 = na
//@variable Take-profit price for &quot;exit2&quot; commands.
var float takeProfit2 = na

// Place orders upon `buyCondition`.
if buyCondition
    if strategy.position_size == 0.0
        stopLoss1   := close * 0.99
        stopLoss2   := close * 0.98
        takeProfit1 := close * 1.01
        takeProfit2 := close * 1.02
    strategy.entry(&quot;buy&quot;, strategy.long, qty = 2)
    strategy.exit(&quot;exit1&quot;, &quot;buy&quot;, stop = stopLoss1, limit = takeProfit1, qty = 1)
    strategy.exit(&quot;exit2&quot;, &quot;buy&quot;, stop = stopLoss2, limit = takeProfit2, qty = 3)

// Set `stopLoss1` and `takeProfit1` to `na` when price touches either.
if low &lt;= stopLoss1 or high &gt;= takeProfit1
    stopLoss1   := na
    takeProfit1 := na
// Set `stopLoss2` and `takeProfit2` to `na` when price touches either.
if low &lt;= stopLoss2 or high &gt;= takeProfit2
    stopLoss2   := na
    takeProfit2 := na

plot(stopLoss1, &quot;SL1&quot;, color.red, style = plot.style_circles)
plot(stopLoss2, &quot;SL2&quot;, color.red, style = plot.style_circles)
plot(takeProfit1, &quot;TP1&quot;, color.green, style = plot.style_circles)
plot(takeProfit2, &quot;TP2&quot;, color.green, style = plot.style_circles)
</pre></div>
</div>
<p>As we can see from the order marks on the chart, the strategy filled “exit2” orders despite the specified <code class="docutils literal notranslate"><span class="pre">qty</span></code> value exceeding the
traded amount. Rather than using this quantity, the script reduced the orders’ sizes to match the remaining position.</p>
<dl class="docutils">
<dt>Note that:</dt>
<dd><ul class="first last simple">
<li>All orders generated from a <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}exit">strategy.exit()</a>
call belong to the same <a class="reference internal" href="#pagestrategies-ocagroups-strategyocareduce"><span class="std std-ref">strategy.oca.reduce</span></a> group, meaning that when either
order fills, the strategy reduces all others to match the open position.</li>
</ul>
</dd>
</dl>
<p>It’s important to note that orders produced by this command reserve a portion of the open market position to exit.
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}exit">strategy.exit()</a> cannot place
an order to exit a portion of the position already reserved for exit by another exit command.</p>
<p>The following script simulates a “buy” market order for 20 shares 100 bars ago with “limit” and “stop” orders of 19 and 20 shares
respectively. As we see on the chart, the strategy executed the “stop” order first. However, the traded quantity was only one share.
Since the script placed the “limit” order first, the strategy reserved its <code class="docutils literal notranslate"><span class="pre">qty</span></code> (19 shares) to close the open position, leaving only
one share to be closed by the “stop” order:</p>
<img alt="../_images/Strategies-Orders-and-entries-Order-placement-commands-5a.png" src="../_images/Strategies-Orders-and-entries-Order-placement-commands-5a.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;Reserved exit demo&quot;, &quot;test&quot;, overlay = true)

//@variable &quot;stop&quot; exit order price.
var float stop   = na
//@variable &quot;limit&quot; exit order price
var float limit  = na
//@variable Is `true` 100 bars before the `last_bar_index`.
longCondition = last_bar_index - bar_index == 100

if longCondition
    stop  := close * 0.99
    limit := close * 1.01
    strategy.entry(&quot;buy&quot;, strategy.long, 20)
    strategy.exit(&quot;limit&quot;, limit = limit,  qty = 19)
    strategy.exit(&quot;stop&quot;, stop = stop, qty = 20)

bool showPlot = strategy.position_size != 0
plot(showPlot ? stop : na, &quot;Stop&quot;, color.red, 2, plot.style_linebr)
plot(showPlot ? limit : na, &quot;Limit 1&quot;, color.green, 2, plot.style_linebr)
</pre></div>
</div>
<p>Another key feature of the <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}exit">strategy.exit()</a> function is
that it can create <em>trailing stops</em>, i.e., stop-loss orders that trail behind the market price by a specified amount whenever the price
moves to a better value in the favorable direction. These orders have two components: the activation level and the trail offset. The activation
level is the value the market price must cross to activate the trailing stop calculation, expressed in ticks via the <code class="docutils literal notranslate"><span class="pre">trail_points</span></code> parameter
or as a price value via the <code class="docutils literal notranslate"><span class="pre">trail_price</span></code> parameter. If an exit call contains both arguments, the <code class="docutils literal notranslate"><span class="pre">trail_price</span></code> argument takes precedence.
The trail offset is the distance the stop will follow behind the market price, expressed in ticks via the <code class="docutils literal notranslate"><span class="pre">trail_offset</span></code> parameter.
For <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}exit">strategy.exit()</a> to create and activate trailing stops,
the function call must contain <code class="docutils literal notranslate"><span class="pre">trail_offset</span></code> and either <code class="docutils literal notranslate"><span class="pre">trail_price</span></code> or <code class="docutils literal notranslate"><span class="pre">trail_points</span></code> arguments.</p>
<p>The example below shows a trailing stop in action and visualizes its behavior. The strategy simulates a long entry order on the bar 100 bars
before the last bar on the chart, then a trailing stop on the next bar. The script has two inputs: one controls the activation level offset
(i.e., the amount past the entry price required to activate the stop), and the other controls the trail offset (i.e., the distance to follow
behind the market price when it moves to a better value in the desired direction).</p>
<p>The green dashed line on the chart shows the level the market price must cross to trigger the trailing stop order. After the price crosses this
level, the script plots a blue line to signify the trailing stop. When the price rises to a new high value, which is favorable for the strategy
since it means the position’s value is increasing, the stop also rises to maintain a distance of <code class="docutils literal notranslate"><span class="pre">trailingStopOffset</span></code> ticks behind the current
price. When the price decreases or doesn’t reach a new high point, the stop value stays the same. Eventually, the price crosses below the stop,
triggering the exit:</p>
<img alt="../_images/Strategies-Orders-and-entries-Order-placement-commands-5b.png" src="../_images/Strategies-Orders-and-entries-Order-placement-commands-5b.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;Trailing stop order demo&quot;, overlay = true, margin_long = 100, margin_short = 100)

//@variable Offset used to determine how far above the entry price (in ticks) the activation level will be located.
activationLevelOffset = input(1000, &quot;Activation Level Offset (in ticks)&quot;)
//@variable Offset used to determine how far below the high price (in ticks) the trailing stop will trail the chart.
trailingStopOffset = input(2000, &quot;Trailing Stop Offset (in ticks)&quot;)

//@function Displays text passed to `txt` when called and shows the `price` level on the chart.
debugLabel(price, txt, lblColor, hasLine = false) =&gt;
    label.new(
         bar_index, price, text = txt, color = lblColor, textcolor = color.white,
         style = label.style_label_lower_right, size = size.large
     )
    if hasLine
        line.new(
             bar_index, price, bar_index + 1, price, color = lblColor, extend = extend.right,
             style = line.style_dashed
         )

//@variable The price at which the trailing stop activation level is located.
var float trailPriceActivationLevel = na
//@variable The price at which the trailing stop itself is located.
var float trailingStop = na
//@variable Caclulates the value that Trailing Stop would have if it were active at the moment.
theoreticalStopPrice = high - trailingStopOffset * syminfo.mintick

// Generate a long market order to enter 100 bars before the last bar.
if last_bar_index - bar_index == 100
    strategy.entry(&quot;Long&quot;, strategy.long)

// Generate a trailing stop 99 bars before the last bar.
if last_bar_index - bar_index == 99
    trailPriceActivationLevel := open + syminfo.mintick * activationLevelOffset
    strategy.exit(
         &quot;Trailing Stop&quot;, from_entry = &quot;Long&quot;, trail_price = trailPriceActivationLevel,
         trail_offset = trailingStopOffset
     )
    debugLabel(trailPriceActivationLevel, &quot;Trailing Stop Activation Level&quot;, color.green, true)

// Visualize the trailing stop mechanic in action.
// If there is an open trade, check whether the Activation Level has been achieved.
// If it has been achieved, track the trailing stop by assigning its value to a variable.
if strategy.opentrades == 1
    if na(trailingStop) and high &gt; trailPriceActivationLevel
        debugLabel(trailPriceActivationLevel, &quot;Activation level crossed&quot;, color.green)
        trailingStop := theoreticalStopPrice
        debugLabel(trailingStop, &quot;Trailing Stop Activated&quot;, color.blue)

    else if theoreticalStopPrice &gt; trailingStop
        trailingStop := theoreticalStopPrice

// Visualize the movement of the trailing stop.
plot(trailingStop, &quot;Trailing Stop&quot;)
</pre></div>
</div>
</div>
<div class="section" id="strategy-close-and-strategy-close-all">
<span id="pagestrategies-ordersandentries-orderplacementcommands-strategyclose"></span><h4><a class="toc-backref" href="#id20">`strategy.close()` and `strategy.close_all()`</a><a class="headerlink" href="#strategy-close-and-strategy-close-all" title="Permalink to this headline">¶</a></h4>
<p>These commands simulate exit positions using market orders. The functions close trades upon being called rather than at a specific price.</p>
<p>The example below demonstrates a simple strategy that places a “buy” order via
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}entry">strategy.entry()</a> once every 50 bars that it
closes with a market order using <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}close">strategy.close()</a>
25 bars afterward:</p>
<img alt="../_images/Strategies-Orders-and-entries-Order-placement-commands-6.png" src="../_images/Strategies-Orders-and-entries-Order-placement-commands-6.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;Close demo&quot;, &quot;test&quot;, overlay = true)

//@variable Is `true` on every 50th bar.
buyCond = bar_index % 50 == 0
//@variable Is `true` on every 25th bar except for those that are divisible by 50.
sellCond = bar_index % 25 == 0 and not buyCond

if buyCond
    strategy.entry(&quot;buy&quot;, strategy.long)
if sellCond
    strategy.close(&quot;buy&quot;)

bgcolor(buyCond  ? color.new(color.blue, 90) : na)
bgcolor(sellCond ? color.new(color.red, 90) : na)
</pre></div>
</div>
<p>Unlike most other order placement commands, the <code class="docutils literal notranslate"><span class="pre">id</span></code> parameter of
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}close">strategy.close()</a>
references an existing entry ID to close. If the specified <code class="docutils literal notranslate"><span class="pre">id</span></code> does not exist, the command will not execute an order.
If a position was formed from multiple entries with the same ID, the command will exit all entries simultaneously.</p>
<p>To demonstrate, the following script places a “buy” order once every 25 bars. The script closes all “buy” entries once every
100 bars. We’ve included <code class="docutils literal notranslate"><span class="pre">pyramiding</span> <span class="pre">=</span> <span class="pre">3</span></code> in the <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy">strategy()</a>
declaration statement to allow the strategy to simulate up to three orders in the same direction:</p>
<img alt="../_images/Strategies-Orders-and-entries-Order-placement-commands-7.png" src="../_images/Strategies-Orders-and-entries-Order-placement-commands-7.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;Multiple close demo&quot;, &quot;test&quot;, overlay = true, pyramiding = 3)

//@variable Is `true` on every 100th bar.
sellCond = bar_index % 100 == 0
//@variable Is `true` on every 25th bar except for those that are divisible by 100.
buyCond = bar_index % 25 == 0 and not sellCond

if buyCond
    strategy.entry(&quot;buy&quot;, strategy.long)
if sellCond
    strategy.close(&quot;buy&quot;)

bgcolor(buyCond  ? color.new(color.blue, 90) : na)
bgcolor(sellCond ? color.new(color.red, 90) : na)
</pre></div>
</div>
<p>For cases where a script has multiple entries with different IDs, the
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}close_all">strategy.close_all()</a>
command can come in handy since it closes all entries, irrespective of their IDs.</p>
<p>The script below places “A”, “B”, and “C” entry orders sequentially based on the number of open trades,
then closes all of them with a single market order:</p>
<img alt="../_images/Strategies-Orders-and-entries-Order-placement-commands-8.png" src="../_images/Strategies-Orders-and-entries-Order-placement-commands-8.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;Close multiple ID demo&quot;, &quot;test&quot;, overlay = true, pyramiding = 3)

switch strategy.opentrades
    0 =&gt; strategy.entry(&quot;A&quot;, strategy.long)
    1 =&gt; strategy.entry(&quot;B&quot;, strategy.long)
    2 =&gt; strategy.entry(&quot;C&quot;, strategy.long)
    3 =&gt; strategy.close_all()
</pre></div>
</div>
</div>
<div class="section" id="strategy-cancel-and-strategy-cancel-all">
<span id="pagestrategies-ordersandentries-orderplacementcommands-strategycancel"></span><h4><a class="toc-backref" href="#id21">`strategy.cancel()` and `strategy.cancel_all()`</a><a class="headerlink" href="#strategy-cancel-and-strategy-cancel-all" title="Permalink to this headline">¶</a></h4>
<p>These commands allow a strategy to cancel pending orders, i.e., those generated by
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}exit">strategy.exit()</a>
or by <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}order">strategy.order()</a>
or <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}entry">strategy.entry()</a>
when they use <code class="docutils literal notranslate"><span class="pre">limit</span></code> or <code class="docutils literal notranslate"><span class="pre">stop</span></code> arguments.</p>
<p>The following strategy simulates a “buy” limit order 500 ticks below the closing price 100 bars ago, then
cancels the order on the next bar. The script draws a horizontal line at the <code class="docutils literal notranslate"><span class="pre">limitPrice</span></code> and colors the
background green and orange to indicate when the limit order is placed and canceled respectively. As we can see,
nothing happened once the market price crossed the <code class="docutils literal notranslate"><span class="pre">limitPrice</span></code> because the strategy already canceled the
order:</p>
<img alt="../_images/Strategies-Orders-and-entries-Order-placement-commands-9.png" src="../_images/Strategies-Orders-and-entries-Order-placement-commands-9.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;Cancel demo&quot;, &quot;test&quot;, overlay = true)

//@variable Draws a horizontal line at the `limit` price of the &quot;buy&quot; order.
var line limitLine = na

//@variable Returns `color.green` when the strategy places the &quot;buy&quot; order, `color.orange` when it cancels the order.
color bgColor = na

if last_bar_index - bar_index == 100
    float limitPrice = close - syminfo.mintick * 500
    strategy.entry(&quot;buy&quot;, strategy.long, limit = limitPrice)
    limitLine := line.new(bar_index, limitPrice, bar_index + 1, limitPrice, extend = extend.right)
    bgColor := color.new(color.green, 50)

if last_bar_index - bar_index == 99
    strategy.cancel(&quot;buy&quot;)
    bgColor := color.new(color.orange, 50)

bgcolor(bgColor)
</pre></div>
</div>
<p>As with <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}close">strategy.close()</a>, the <code class="docutils literal notranslate"><span class="pre">id</span></code>
parameter of <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}cancel">strategy.cancel()</a>
refers to the ID of an existing entry. This command will do nothing if the <code class="docutils literal notranslate"><span class="pre">id</span></code> parameter references an ID that doesn’t
exist. When there are multiple pending orders with the same ID, this command will cancel all of them at once.</p>
<p>In this example, we’ve modified the previous script to place a “buy” limit order on three consecutive bars starting from
100 bars ago. The strategy cancels all of them after the <code class="docutils literal notranslate"><span class="pre">bar_index</span></code> is 97 bars away from the most recent bar, resulting
in it doing nothing when the price crosses any of the lines:</p>
<img alt="../_images/Strategies-Orders-and-entries-Order-placement-commands-10.png" src="../_images/Strategies-Orders-and-entries-Order-placement-commands-10.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;Multiple cancel demo&quot;, &quot;test&quot;, overlay = true, pyramiding = 3)

//@variable Draws a horizontal line at the `limit` price of the &quot;buy&quot; order.
var line limitLine = na

//@variable Returns `color.green` when the strategy places the &quot;buy&quot; order, `color.orange` when it cancels the order.
color bgColor = na

if last_bar_index - bar_index &lt;= 100 and last_bar_index - bar_index &gt;= 98
    float limitPrice = close - syminfo.mintick * 500
    strategy.entry(&quot;buy&quot;, strategy.long, limit = limitPrice)
    limitLine := line.new(bar_index, limitPrice, bar_index + 1, limitPrice, extend = extend.right)
    bgColor := color.new(color.green, 50)

if last_bar_index - bar_index == 97
    strategy.cancel(&quot;buy&quot;)
    bgColor := color.new(color.orange, 50)

bgcolor(bgColor)
</pre></div>
</div>
<dl class="docutils">
<dt>Note that:</dt>
<dd><ul class="first last simple">
<li>We added <code class="docutils literal notranslate"><span class="pre">pyramiding</span> <span class="pre">=</span> <span class="pre">3</span></code> to the script’s declaration statement to allow three
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}entry">strategy.entry()</a>
orders to fill. Alternatively, the script would achieve the same output by using
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}order">strategy.order()</a>
since it isn’t sensitive to the <code class="docutils literal notranslate"><span class="pre">pyramiding</span></code> setting.</li>
</ul>
</dd>
</dl>
<p>It’s important to note that neither <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}cancel">strategy.cancel()</a>
nor <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}cancel_all">strategy.cancel_all()</a>
can cancel <em>market</em> orders, as the strategy executes them immediately upon the next tick. Strategies cannot cancel
orders after they’ve been filled. To close an open position, use
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}close">strategy.close()</a> or
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}close_all">strategy.close_all()</a>.</p>
<p>This example simulates a “buy” market order 100 bars ago, then attempts to cancel all pending orders on the next bar.
Since the strategy already filled the “buy” order, the
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}cancel_all">strategy.cancel_all()</a> command
does nothing in this case, as there are no pending orders to cancel:</p>
<img alt="../_images/Strategies-Orders-and-entries-Order-placement-commands-11.png" src="../_images/Strategies-Orders-and-entries-Order-placement-commands-11.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;Cancel market demo&quot;, &quot;test&quot;, overlay = true)

//@variable Returns `color.green` when the strategy places the &quot;buy&quot; order, `color.orange` when it tries to cancel.
color bgColor = na

if last_bar_index - bar_index == 100
    strategy.entry(&quot;buy&quot;, strategy.long)
    bgColor := color.new(color.green, 50)

if last_bar_index - bar_index == 99
    strategy.cancel_all()
    bgColor := color.new(color.orange, 50)

bgcolor(bgColor)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="position-sizing">
<span id="pagestrategies-positionsizing"></span><h2><a class="toc-backref" href="#id22">Position sizing</a><a class="headerlink" href="#position-sizing" title="Permalink to this headline">¶</a></h2>
<p>Pine Script<sup>®</sup> strategies feature two ways to control the sizes of simulated trades:</p>
<ul class="simple">
<li>Set a default fixed quantity type and value for all orders using the <code class="docutils literal notranslate"><span class="pre">default_qty_type</span></code> and <code class="docutils literal notranslate"><span class="pre">default_qty_value</span></code> arguments in the <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy">strategy()</a> function, which also sets the default values in the “Properties” tab of the script settings.</li>
<li>Specify the <code class="docutils literal notranslate"><span class="pre">qty</span></code> argument when calling <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}entry">strategy.entry()</a>. When a user supplies this argument to the function, the script ignores the strategy’s default quantity value and type.</li>
</ul>
<p>The following example simulates “Buy” orders of <code class="docutils literal notranslate"><span class="pre">longAmount</span></code> size whenever the <code class="docutils literal notranslate"><span class="pre">low</span></code>
price equals the <code class="docutils literal notranslate"><span class="pre">lowest</span></code> value, and “Sell” orders of <code class="docutils literal notranslate"><span class="pre">shortAmount</span></code> size when the
<code class="docutils literal notranslate"><span class="pre">high</span></code> price equals the <code class="docutils literal notranslate"><span class="pre">highest</span></code> value:</p>
<img alt="../_images/Strategies-Position-sizing-1.png" src="../_images/Strategies-Position-sizing-1.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;Buy low, sell high&quot;, overlay = true, default_qty_type = strategy.cash, default_qty_value = 5000)

int   length      = input.int(20, &quot;Length&quot;)
float longAmount  = input.float(4.0, &quot;Long Amount&quot;)
float shortAmount = input.float(2.0, &quot;Short Amount&quot;)

float highest = ta.highest(length)
float lowest  = ta.lowest(length)

switch
    low == lowest   =&gt; strategy.entry(&quot;Buy&quot;, strategy.long, longAmount)
    high == highest =&gt; strategy.entry(&quot;Sell&quot;, strategy.short, shortAmount)
</pre></div>
</div>
<p>Notice that in the above example, although we’ve specified the <code class="docutils literal notranslate"><span class="pre">default_qty_type</span></code>
and <code class="docutils literal notranslate"><span class="pre">default_qty_value</span></code> arguments in the declaration statement, the script does
not use these defaults for the simulated orders. Instead, it sizes them as a
<code class="docutils literal notranslate"><span class="pre">longAmount</span></code> and <code class="docutils literal notranslate"><span class="pre">shortAmount</span></code> of units. If we want the script to use the default
type and value, we must remove the <code class="docutils literal notranslate"><span class="pre">qty</span></code> specification from the
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}entry">strategy.entry()</a>
calls:</p>
<img alt="../_images/Strategies-Position-sizing-2.png" src="../_images/Strategies-Position-sizing-2.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;Buy low, sell high&quot;, overlay = true, default_qty_type = strategy.cash, default_qty_value = 5000)

int length = input.int(20, &quot;Length&quot;)

float highest = ta.highest(length)
float lowest  = ta.lowest(length)

switch
    low == lowest   =&gt; strategy.entry(&quot;Buy&quot;, strategy.long)
    high == highest =&gt; strategy.entry(&quot;Sell&quot;, strategy.short)
</pre></div>
</div>
</div>
<div class="section" id="closing-a-market-position">
<span id="pagestrategies-closingamarketposition"></span><h2><a class="toc-backref" href="#id23">Closing a market position</a><a class="headerlink" href="#closing-a-market-position" title="Permalink to this headline">¶</a></h2>
<p>Although it is possible to simulate an exit from a specific entry order shown in the
<span class="xref std std-ref">List of Trades</span> tab of the
<a class="reference internal" href="#pagestrategies-strategytester"><span class="std std-ref">Strategy Tester</span></a> module, all orders are linked
according to FIFO (first in, first out) rules. If the user does not specify the <code class="docutils literal notranslate"><span class="pre">from_entry</span></code> parameter of a
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}exit">strategy.exit()</a>
call, the strategy will exit the open market position starting from the first entry order that opened it.</p>
<p>The following example simulates two orders sequentially: “Buy1” at the market price
for the last 100 bars and “Buy2” once the position size matches the size of “Buy1”.
The strategy only places an exit order when the <code class="docutils literal notranslate"><span class="pre">positionSize</span></code> is 15 units.
The script does not supply a <code class="docutils literal notranslate"><span class="pre">from_entry</span></code> argument to the
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}exit">strategy.exit()</a>
command, so the strategy places exit orders for all open positions each time it calls the function,
starting with the first. It plots the <code class="docutils literal notranslate"><span class="pre">positionSize</span></code> in a separate pane for visual reference:</p>
<img alt="../_images/Strategies-Closing-a-market-position-1.png" src="../_images/Strategies-Closing-a-market-position-1.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;Exit Demo&quot;, pyramiding = 2)

float positionSize = strategy.position_size

if positionSize == 0 and last_bar_index - bar_index &lt;= 100
    strategy.entry(&quot;Buy1&quot;, strategy.long, 5)
else if positionSize == 5
    strategy.entry(&quot;Buy2&quot;, strategy.long, 10)
else if positionSize == 15
    strategy.exit(&quot;bracket&quot;, loss = 10, profit = 10)

plot(positionSize == 0 ? na : positionSize, &quot;Position Size&quot;, color.lime, 4, plot.style_histogram)
</pre></div>
</div>
<dl class="docutils">
<dt>Note that:</dt>
<dd><ul class="first last simple">
<li>We included <code class="docutils literal notranslate"><span class="pre">pyramiding</span> <span class="pre">=</span> <span class="pre">2</span></code> in our script’s declaration statement to allow it to simulate two consecutive orders in the same direction.</li>
</ul>
</dd>
</dl>
<p>Suppose we wanted to exit “Buy2” before “Buy1”. Let’s see what happens if we instruct
the strategy to close “Buy2” before “Buy1” when it fills both orders:</p>
<img alt="../_images/Strategies-Closing-a-market-position-2.png" src="../_images/Strategies-Closing-a-market-position-2.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;Exit Demo&quot;, pyramiding = 2)

float positionSize = strategy.position_size

if positionSize == 0 and last_bar_index - bar_index &lt;= 100
    strategy.entry(&quot;Buy1&quot;, strategy.long, 5)
else if positionSize == 5
    strategy.entry(&quot;Buy2&quot;, strategy.long, 10)
else if positionSize == 15
    strategy.close(&quot;Buy2&quot;)
    strategy.exit(&quot;bracket&quot;, &quot;Buy1&quot;, loss = 10, profit = 10)

plot(positionSize == 0 ? na : positionSize, &quot;Position Size&quot;, color.lime, 4, plot.style_histogram)
</pre></div>
</div>
<p>As we can see in the Strategy Tester’s “List of Trades” tab, rather than closing the “Buy2”
position with <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}close">strategy.close()</a>,
it closes the quantity of “Buy1” first, which is half the quantity of the close order, then
closes half of the “Buy2” position, as the broker emulator follows FIFO rules by default.
Users can change this behavior by specifying <code class="docutils literal notranslate"><span class="pre">close_entries_rule</span> <span class="pre">=</span> <span class="pre">&quot;ANY&quot;</span></code> in the
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy">strategy()</a> function.</p>
</div>
<div class="section" id="oca-groups">
<span id="pagestrategies-ocagroups"></span><h2><a class="toc-backref" href="#id24">OCA groups</a><a class="headerlink" href="#oca-groups" title="Permalink to this headline">¶</a></h2>
<p>One-Cancels-All (OCA) groups allow a strategy to fully or partially cancel other orders upon the
execution of order placement commands, including
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}entry">strategy.entry()</a>
and <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}order">strategy.order()</a>,
with the same <code class="docutils literal notranslate"><span class="pre">oca_name</span></code>, depending on the <code class="docutils literal notranslate"><span class="pre">oca_type</span></code> that the user provides in the function call.</p>
<div class="section" id="strategy-oca-cancel">
<span id="pagestrategies-ocagroups-strategyocacancel"></span><h3><a class="toc-backref" href="#id25">`strategy.oca.cancel`</a><a class="headerlink" href="#strategy-oca-cancel" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference external" href="../../../../pine-script-reference/v5/index.html#var_strategy{dot}oca{dot}cancel">strategy.oca.cancel</a>
OCA type cancels all orders with the same <code class="docutils literal notranslate"><span class="pre">oca_name</span></code> upon the fill or partial fill of an order from the group.</p>
<p>For example, the following strategy executes orders upon <code class="docutils literal notranslate"><span class="pre">ma1</span></code> crossing <code class="docutils literal notranslate"><span class="pre">ma2</span></code>. When the
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#var_strategy{dot}position_size">strategy.position_size</a>
is 0, it places long and short stop orders on the <code class="docutils literal notranslate"><span class="pre">high</span></code> and <code class="docutils literal notranslate"><span class="pre">low</span></code> of the bar. Otherwise, it calls
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}close_all">strategy.close_all()</a>
to close all open positions with a market order. Depending on the price action, the strategy may fill
both orders before issuing a close order. Additionally, if the broker emulator’s intrabar assumption supports it,
both orders may fill on the same bar. The
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}close_all">strategy.close_all()</a> command
does nothing in such cases, as the script cannot invoke the action until after already executing both orders:</p>
<img alt="../_images/Strategies-OCA-groups-Strategy-oca-cancel-1.png" src="../_images/Strategies-OCA-groups-Strategy-oca-cancel-1.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;OCA Cancel Demo&quot;, overlay=true)

float ma1 = ta.sma(close, 5)
float ma2 = ta.sma(close, 9)

if ta.cross(ma1, ma2)
    if strategy.position_size == 0
        strategy.order(&quot;Long&quot;,  strategy.long, stop = high)
        strategy.order(&quot;Short&quot;, strategy.short, stop = low)
    else
        strategy.close_all()

plot(ma1, &quot;Fast MA&quot;, color.aqua)
plot(ma2, &quot;Slow MA&quot;, color.orange)
</pre></div>
</div>
<p>To eliminate scenarios where the strategy fills long and short orders before a close order,
we can instruct it to cancel one order after it executes the other. In this example, we’ve
set the <code class="docutils literal notranslate"><span class="pre">oca_name</span></code> for both
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}order">strategy.order()</a>
commands to “Entry” and their <code class="docutils literal notranslate"><span class="pre">oca_type</span></code> to <code class="docutils literal notranslate"><span class="pre">strategy.oca.cancel</span></code>:</p>
<img alt="../_images/Strategies-OCA-groups-Strategy-oca-cancel-2.png" src="../_images/Strategies-OCA-groups-Strategy-oca-cancel-2.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;OCA Cancel Demo&quot;, overlay=true)

float ma1 = ta.sma(close, 5)
float ma2 = ta.sma(close, 9)

if ta.cross(ma1, ma2)
    if strategy.position_size == 0
        strategy.order(&quot;Long&quot;,  strategy.long, stop = high, oca_name = &quot;Entry&quot;, oca_type = strategy.oca.cancel)
        strategy.order(&quot;Short&quot;, strategy.short, stop = low, oca_name = &quot;Entry&quot;, oca_type = strategy.oca.cancel)
    else
        strategy.close_all()

plot(ma1, &quot;Fast MA&quot;, color.aqua)
plot(ma2, &quot;Slow MA&quot;, color.orange)
</pre></div>
</div>
</div>
<div class="section" id="strategy-oca-reduce">
<span id="pagestrategies-ocagroups-strategyocareduce"></span><h3><a class="toc-backref" href="#id26">`strategy.oca.reduce`</a><a class="headerlink" href="#strategy-oca-reduce" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference external" href="../../../../pine-script-reference/v5/index.html#var_strategy{dot}oca{dot}reduce">strategy.oca.reduce</a>
OCA type does not cancel orders. Instead, it reduces the size of orders with the same <code class="docutils literal notranslate"><span class="pre">oca_name</span></code> upon each
new fill by the number of closed contracts/shares/lots/units, which is particularly useful for exit strategies.</p>
<p>The following example demonstrates an attempt at a long-only exit strategy that generates a stop-loss order and
two take-profit orders for each new entry. Upon the crossover of two moving averages, it simulates a “Long” entry
order using <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}entry">strategy.entry()</a>
with a <code class="docutils literal notranslate"><span class="pre">qty</span></code> of 6 units, then simulates stop/limit orders for 6, 3, and 3 units using
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}order">strategy.order()</a>
at the <code class="docutils literal notranslate"><span class="pre">stop</span></code>, <code class="docutils literal notranslate"><span class="pre">limit1</span></code>, and <code class="docutils literal notranslate"><span class="pre">limit2</span></code> prices respectively.</p>
<p>After adding the strategy to our chart, we see it doesn’t work as intended. The issue with this script is that
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}order">strategy.order()</a>
doesn’t belong to an OCA group by default, unlike
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}exit">strategy.exit()</a>.
Since we have not explicitly assigned the orders to an OCA group, the strategy does not cancel or reduce
them when it fills one, meaning it’s possible to trade a greater quantity than the open position and reverse the direction:</p>
<img alt="../_images/Strategies-OCA-groups-Strategy-oca-reduce-1.png" src="../_images/Strategies-OCA-groups-Strategy-oca-reduce-1.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;Multiple TP Demo&quot;, overlay = true)

var float stop   = na
var float limit1 = na
var float limit2 = na

bool longCondition = ta.crossover(ta.sma(close, 5), ta.sma(close, 9))
if longCondition and strategy.position_size == 0
    stop   := close * 0.99
    limit1 := close * 1.01
    limit2 := close * 1.02
    strategy.entry(&quot;Long&quot;,  strategy.long, 6)
    strategy.order(&quot;Stop&quot;,  strategy.short, stop = stop, qty = 6)
    strategy.order(&quot;Limit 1&quot;, strategy.short, limit = limit1, qty = 3)
    strategy.order(&quot;Limit 2&quot;, strategy.short, limit = limit2, qty = 3)

bool showPlot = strategy.position_size != 0
plot(showPlot ? stop   : na, &quot;Stop&quot;,    color.red,   style = plot.style_linebr)
plot(showPlot ? limit1 : na, &quot;Limit 1&quot;, color.green, style = plot.style_linebr)
plot(showPlot ? limit2 : na, &quot;Limit 2&quot;, color.green, style = plot.style_linebr)
</pre></div>
</div>
<p>For our strategy to work as intended, we must instruct it to reduce the number of units for the other
stop-loss/take-profit orders so that they do not exceed the size of the remaining open position.</p>
<p>In the example below, we’ve set the <code class="docutils literal notranslate"><span class="pre">oca_name</span></code> for each order in our exit strategy to “Bracket” and the
<code class="docutils literal notranslate"><span class="pre">oca_type</span></code> to
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#var_strategy{dot}oca{dot}reduce">strategy.oca.reduce</a>.
These settings tell the strategy to reduce the <code class="docutils literal notranslate"><span class="pre">qty</span></code> values of orders in the “Bracket” group by the <code class="docutils literal notranslate"><span class="pre">qty</span></code>
filled when it executes one of them, preventing it from trading an excessive number of units and causing a reversal:</p>
<img alt="../_images/Strategies-OCA-groups-Strategy-oca-reduce-2.png" src="../_images/Strategies-OCA-groups-Strategy-oca-reduce-2.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;Multiple TP Demo&quot;, overlay = true)

var float stop   = na
var float limit1 = na
var float limit2 = na

bool longCondition = ta.crossover(ta.sma(close, 5), ta.sma(close, 9))
if longCondition and strategy.position_size == 0
    stop   := close * 0.99
    limit1 := close * 1.01
    limit2 := close * 1.02
    strategy.entry(&quot;Long&quot;,  strategy.long, 6)
    strategy.order(&quot;Stop&quot;,  strategy.short, stop = stop, qty = 6, oca_name = &quot;Bracket&quot;, oca_type = strategy.oca.reduce)
    strategy.order(&quot;Limit 1&quot;, strategy.short, limit = limit1, qty = 3, oca_name = &quot;Bracket&quot;, oca_type = strategy.oca.reduce)
    strategy.order(&quot;Limit 2&quot;, strategy.short, limit = limit2, qty = 6, oca_name = &quot;Bracket&quot;, oca_type = strategy.oca.reduce)

bool showPlot = strategy.position_size != 0
plot(showPlot ? stop   : na, &quot;Stop&quot;,    color.red,   style = plot.style_linebr)
plot(showPlot ? limit1 : na, &quot;Limit 1&quot;, color.green, style = plot.style_linebr)
plot(showPlot ? limit2 : na, &quot;Limit 2&quot;, color.green, style = plot.style_linebr)
</pre></div>
</div>
<dl class="docutils">
<dt>Note that:</dt>
<dd><ul class="first last simple">
<li>We changed the <code class="docutils literal notranslate"><span class="pre">qty</span></code> of the “Limit 2” order to 6 instead of 3 because the strategy will reduce its value by 3 when it fills the “Limit 1” order. Keeping the <code class="docutils literal notranslate"><span class="pre">qty</span></code> value of 3 would cause it to drop to 0 and never fill after filling the first limit order.</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="strategy-oca-none">
<span id="pagestrategies-ocagroups-strategyocanone"></span><h3><a class="toc-backref" href="#id27">`strategy.oca.none`</a><a class="headerlink" href="#strategy-oca-none" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference external" href="../../../../pine-script-reference/v5/index.html#var_strategy{dot}oca{dot}none">strategy.oca.none</a>
OCA type specifies that an order executes independently of any OCA group. This value is the default <code class="docutils literal notranslate"><span class="pre">oca_type</span></code>
for <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}order">strategy.order()</a>
and <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}entry">strategy.entry()</a>
order placement commands.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If two order placement commands have the same <code class="docutils literal notranslate"><span class="pre">oca_name</span></code> but different <code class="docutils literal notranslate"><span class="pre">oca_type</span></code> values,
the strategy considers them to be from two distinct groups. i.e., OCA groups cannot combine
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#var_strategy{dot}oca{dot}cancel">strategy.oca.cancel</a>,
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#var_strategy{dot}oca{dot}reduce">strategy.oca.reduce</a>,
and <a class="reference external" href="../../../../pine-script-reference/v5/index.html#var_strategy{dot}oca{dot}none">strategy.oca.none</a>
OCA types.</p>
</div>
</div>
</div>
<div class="section" id="currency">
<span id="pagestrategies-currency"></span><h2><a class="toc-backref" href="#id28">Currency</a><a class="headerlink" href="#currency" title="Permalink to this headline">¶</a></h2>
<p>Pine Script<sup>®</sup> strategies can use different base currencies than the instruments they calculate on.
Users can specify the simulated account’s base currency by including a <code class="docutils literal notranslate"><span class="pre">currency.*</span></code> variable as
the <code class="docutils literal notranslate"><span class="pre">currency</span></code> argument in the
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy">strategy()</a>
function, which will change the script’s
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#var_strategy{dot}account_currency">strategy.account_currency</a>
value. The default <code class="docutils literal notranslate"><span class="pre">currency</span></code> value for strategies is <code class="docutils literal notranslate"><span class="pre">currency.NONE</span></code>, meaning that the script
uses the base currency of the instrument on the chart.</p>
<p>When a strategy script uses a specified base currency, it multiplies the simulated profits by the
FX_IDC conversion rate from the previous trading day. For example, the strategy below places an entry
order for a standard lot (100,000 units) with a profit target and stop-loss of 1 point on each of the
last 500 chart bars, then plots the net profit alongside the inverted daily close of the symbol in a
separate pane. We have set the base currency to <code class="docutils literal notranslate"><span class="pre">currency.EUR</span></code>. When we add this script to FX_IDC:EURUSD,
the two plots align, confirming the strategy uses the previous day’s rate from this symbol for its calculations:</p>
<img alt="../_images/Strategies-Currency-1.png" src="../_images/Strategies-Currency-1.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;Currency Test&quot;, currency = currency.EUR)

if last_bar_index - bar_index &lt; 500
    strategy.entry(&quot;LE&quot;, strategy.long, 100000)
    strategy.exit(&quot;LX&quot;, &quot;LE&quot;, profit = 1, loss = 1)
plot(math.abs(ta.change(strategy.netprofit)), &quot;1 Point profit&quot;, color = color.fuchsia, linewidth = 4)
plot(request.security(syminfo.tickerid, &quot;D&quot;, 1 / close)[1], &quot;Previous day&#39;s inverted price&quot;, color = color.lime)
</pre></div>
</div>
<dl class="docutils">
<dt>Note that:</dt>
<dd><ul class="first last simple">
<li>When trading on timeframes higher than daily, the strategy will use the closing price from one trading day
before the bar closes for cross-rate calculation on historical bars. For example, on a weekly timeframe,
it will base the cross-rate on the previous Thursday’s closing value, though the strategy will still use
the daily closing rate for real-time bars.</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="altering-calculation-behavior">
<span id="pagestrategies-alteringcalculationbehavior"></span><h2><a class="toc-backref" href="#id29">Altering calculation behavior</a><a class="headerlink" href="#altering-calculation-behavior" title="Permalink to this headline">¶</a></h2>
<p>Strategies execute on all historical bars available from a chart, then automatically continue their
calculations in real-time as new data is available. By default, strategy scripts only calculate once
per confirmed bar. We can alter this behavior by changing the parameters of the
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy">strategy()</a>
function or clicking the checkboxes in the “Recalculate” section of the script’s “Properties” tab.</p>
<div class="section" id="calc-on-every-tick">
<span id="pagestrategies-alteringcalculationbehavior-calconeverytick"></span><h3><a class="toc-backref" href="#id30">`calc_on_every_tick`</a><a class="headerlink" href="#calc-on-every-tick" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">calc_on_every_tick</span></code> is an optional setting that controls the calculation behavior on
real-time data. When this parameter is enabled, the script will recalculate its values on
each new price tick. By default, its value is false, meaning the script only executes
calculations after a bar is confirmed.</p>
<p>Enabling this calculation behavior may be particularly useful when forward testing since it
facilitates granular, real-time strategy simulation. However, it’s important to note that this
behavior introduces a data difference between real-time and historical simulations, as historical
bars do not contain tick information. Users should exercise caution with this setting, as the data
difference may cause a strategy to repaint its history.</p>
<p>The following script will simulate a new order each time that <code class="docutils literal notranslate"><span class="pre">close</span></code> reaches the <code class="docutils literal notranslate"><span class="pre">highest</span></code> or
<code class="docutils literal notranslate"><span class="pre">lowest</span></code> value over the input <code class="docutils literal notranslate"><span class="pre">length</span></code>. Since <code class="docutils literal notranslate"><span class="pre">calc_on_every_tick</span></code> is enabled in the strategy
declaration, the script will simulate new orders on each new real-time price tick after compilation:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;Donchian Channel Break&quot;, overlay = true, calc_on_every_tick = true, pyramiding = 20)

int length = input.int(15, &quot;Length&quot;)

float highest = ta.highest(close, length)
float lowest  = ta.lowest(close, length)

if close == highest
    strategy.entry(&quot;Buy&quot;, strategy.long)
if close == lowest
    strategy.entry(&quot;Sell&quot;, strategy.short)

//@variable The starting time for real-time bars.
var realTimeStart = timenow

// Color the background of real-time bars.
bgcolor(time_close &gt;= realTimeStart ? color.new(color.orange, 80) : na)

plot(highest, &quot;Highest&quot;, color = color.lime)
plot(lowest, &quot;Lowest&quot;, color = color.red)
</pre></div>
</div>
<dl class="docutils">
<dt>Note that:</dt>
<dd><ul class="first last simple">
<li>The script uses a <code class="docutils literal notranslate"><span class="pre">pyramiding</span></code> value of 20 in its declaration, which allows the
strategy to simulate a maximum of 20 trades in the same direction.</li>
<li>To visually demarcate what bars are processed as real-time bars by the strategy,
the script colors the background for all bars since the
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#var_timenow">timenow</a>
when it was last compiled.</li>
</ul>
</dd>
</dl>
<p>After applying the script to the chart and letting it calculate on some real-time bars,
we may see an output like the following:</p>
<img alt="../_images/Strategies-Altering-calculation-behavior-Calc-on-every-tick-1.png" src="../_images/Strategies-Altering-calculation-behavior-Calc-on-every-tick-1.png" />
<p>The script placed “Buy” orders on each new real-time tick the condition was valid on, resulting in
multiple orders per bar. However, it may surprise users unfamiliar with this behavior to see the
strategy’s outputs change after recompiling the script, as the bars that it previously executed real-time
calculations on are now historical bars, which do not hold tick information:</p>
<img alt="../_images/Strategies-Altering-calculation-behavior-Calc-on-every-tick-2.png" src="../_images/Strategies-Altering-calculation-behavior-Calc-on-every-tick-2.png" />
</div>
<div class="section" id="calc-on-order-fills">
<span id="pagestrategies-alteringcalculationbehavior-calconorderfills"></span><h3><a class="toc-backref" href="#id31">`calc_on_order_fills`</a><a class="headerlink" href="#calc-on-order-fills" title="Permalink to this headline">¶</a></h3>
<p>The optional <code class="docutils literal notranslate"><span class="pre">calc_on_order_fills</span></code> setting enables the recalculation of a strategy immediately after
simulating an order fill, which allows the script to use more granular prices and place additional orders
without waiting for a bar to be confirmed.</p>
<p>Enabling this setting can provide the script with additional data that would otherwise not be available
until after a bar closes, such as the current average price of a simulated position on an unconfirmed bar.</p>
<p>The example below shows a simple strategy declared with <code class="docutils literal notranslate"><span class="pre">calc_on_order_fills</span></code> enabled that simulates a “Buy” order when the
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#var_strategy{dot}position_size">strategy.position_size</a> is 0.
The script uses the
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#var_strategy{dot}position_avg_price">strategy.position_avg_price</a>
to calculate a <code class="docutils literal notranslate"><span class="pre">stopLoss</span></code> and <code class="docutils literal notranslate"><span class="pre">takeProfit</span></code> and simulates “Exit” orders when the price crosses them, regardless of whether
the bar is confirmed. As a result, as soon as an exit is triggered, the strategy recalculates and places a new entry order because
the <a class="reference external" href="../../../../pine-script-reference/v5/index.html#var_strategy{dot}position_size">strategy.position_size</a>
is once again equal to 0. The strategy places the order once the exit happens and executes it on the next tick after the exit,
which will be one of the bar’s OHLC values, depending on the emulated intrabar movement:</p>
<img alt="../_images/Strategies-Altering-calculation-behavior-Calc-on-order-fills-1.png" src="../_images/Strategies-Altering-calculation-behavior-Calc-on-order-fills-1.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;Intrabar exit&quot;, overlay = true, calc_on_order_fills = true)

float stopSize   = input.float(5.0, &quot;SL %&quot;, minval = 0.0) / 100.0
float profitSize = input.float(5.0, &quot;TP %&quot;, minval = 0.0) / 100.0

if strategy.position_size == 0.0
    strategy.entry(&quot;Buy&quot;, strategy.long)

float stopLoss   = strategy.position_avg_price * (1.0 - stopSize)
float takeProfit = strategy.position_avg_price * (1.0 + profitSize)

strategy.exit(&quot;Exit&quot;, stop = stopLoss, limit = takeProfit)
</pre></div>
</div>
<dl class="docutils">
<dt>Note that:</dt>
<dd><ul class="first last simple">
<li>With <code class="docutils literal notranslate"><span class="pre">calc_on_order_fills</span></code> turned off, the same strategy will only ever enter one bar after it triggers an exit order.
First, the mid-bar exit will happen, but no entry order. Then, the strategy will simulate an entry order once the bar
closes, which it will fill on the next tick after that, i.e., the open of the next bar.</li>
</ul>
</dd>
</dl>
<p>It’s important to note that enabling <code class="docutils literal notranslate"><span class="pre">calc_on_order_fills</span></code> may produce unrealistic strategy results,
as the broker emulator may assume order prices that are not possible when trading in real-time.
Users must exercise caution with this setting and carefully consider the logic in their scripts.</p>
<p>The following example simulates a “Buy” order after each new order fill and bar confirmation over a 25-bar window from the
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#var_last_bar_index">last_bar_index</a>
when the script loaded on the chart. With the setting enabled, the strategy simulates four entries per bar
since the emulator considers each bar to have four ticks (open, high, low, close), which is unrealistic behavior,
as it’s not typically possible for an order to fill at the exact high or low of a bar:</p>
<img alt="../_images/Strategies-Altering-calculation-behavior-Calc-on-order-fills-2.png" src="../_images/Strategies-Altering-calculation-behavior-Calc-on-order-fills-2.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;buy on every fill&quot;, overlay = true, calc_on_order_fills = true, pyramiding = 100)

if last_bar_index - bar_index &lt;= 25
    strategy.entry(&quot;Buy&quot;, strategy.long)
</pre></div>
</div>
</div>
<div class="section" id="process-orders-on-close">
<span id="pagestrategies-alteringcalculationbehavior-processordersonclose"></span><h3><a class="toc-backref" href="#id32">`process_orders_on_close`</a><a class="headerlink" href="#process-orders-on-close" title="Permalink to this headline">¶</a></h3>
<p>The default strategy behavior simulates orders at the close of each bar, meaning that the earliest
opportunity to fill the orders and execute strategy calculations and alerts is upon the opening of
the following bar. Traders can change this behavior to process a strategy using the closing value
of each bar by enabling the <code class="docutils literal notranslate"><span class="pre">process_orders_on_close</span></code> setting.</p>
<p>This behavior is most useful when backtesting manual strategies in which traders exit positions
before a bar closes or in scenarios where algorithmic traders in non-24x7 markets set up after-hours
trading capability so that alerts sent after close still have hope of filling before the following day.</p>
<dl class="docutils">
<dt>Note that:</dt>
<dd><ul class="first last simple">
<li>It’s crucial to be aware that using strategies with <code class="docutils literal notranslate"><span class="pre">process_orders_on_close</span></code> in a live trading
environment may lead to a repainting strategy, as alerts on the close of a bar still occur when the
market closes, and orders may not fill until the next market open.</li>
</ul>
</dd>
</dl>
</div>
</div>
<div class="section" id="simulating-trading-costs">
<span id="pagestrategies-simulatingtradingcosts"></span><h2><a class="toc-backref" href="#id33">Simulating trading costs</a><a class="headerlink" href="#simulating-trading-costs" title="Permalink to this headline">¶</a></h2>
<p>For a strategy performance report to contain relevant, meaningful data, traders should strive to
account for potential real-world costs in their strategy results. Neglecting to do so may give
traders an unrealistic view of strategy performance and undermine the credibility of test results.
Without modeling the potential costs associated with their trades, traders may overestimate a
strategy’s historical profitability, potentially leading to suboptimal decisions in live trading.
Pine Script<sup>®</sup> strategies include inputs and parameters for simulating trading costs in performance results.</p>
<div class="section" id="commission">
<span id="pagestrategies-simulatingtradingcosts-commission"></span><h3><a class="toc-backref" href="#id34">Commission</a><a class="headerlink" href="#commission" title="Permalink to this headline">¶</a></h3>
<p>Commission refers to the fee a broker/exchange charges when executing trades. Depending on the broker/exchange,
some may charge a flat fee per trade or contract/share/lot/unit, and others may charge a percentage of the total
transaction value. Users can set the commission properties of their strategies by including <code class="docutils literal notranslate"><span class="pre">commission_type</span></code>
and <code class="docutils literal notranslate"><span class="pre">commission_value</span></code> arguments in the <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy">strategy()</a>
function or by setting the “Commission” inputs in the “Properties” tab of the strategy settings.</p>
<p>The following script is a simple strategy that simulates a “Long” position of 2% of equity when <code class="docutils literal notranslate"><span class="pre">close</span></code> equals
the <code class="docutils literal notranslate"><span class="pre">highest</span></code> value over the <code class="docutils literal notranslate"><span class="pre">length</span></code>, and closes the trade when it equals the <code class="docutils literal notranslate"><span class="pre">lowest</span></code> value:</p>
<img alt="../_images/Strategies-Simulating-trading-costs-Commission-1.png" src="../_images/Strategies-Simulating-trading-costs-Commission-1.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(&quot;Commission Demo&quot;, overlay=true, default_qty_value = 2, default_qty_type = strategy.percent_of_equity)

length = input.int(10, &quot;Length&quot;)

float highest = ta.highest(close, length)
float lowest  = ta.lowest(close, length)

switch close
    highest =&gt; strategy.entry(&quot;Long&quot;, strategy.long)
    lowest  =&gt; strategy.close(&quot;Long&quot;)

plot(highest, color = color.new(color.lime, 50))
plot(lowest, color = color.new(color.red, 50))
</pre></div>
</div>
<p>Upon inspecting the results in the Strategy Tester, we see that the strategy had a positive equity growth of
17.61% over the testing range. However, the backtest results do not account for fees the broker/exchange may
charge. Let’s see what happens to these results when we include a small commission on every trade in the
strategy simulation. In this example, we’ve included <code class="docutils literal notranslate"><span class="pre">commission_type</span> <span class="pre">=</span> <span class="pre">strategy.commission.percent</span></code>
and <code class="docutils literal notranslate"><span class="pre">commission_value</span> <span class="pre">=</span> <span class="pre">1</span></code> in the <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy">strategy()</a>
declaration, meaning it will simulate a commission of 1% on all executed orders:</p>
<img alt="../_images/Strategies-Simulating-trading-costs-Commission-2.png" src="../_images/Strategies-Simulating-trading-costs-Commission-2.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(
     &quot;Commission Demo&quot;, overlay=true, default_qty_value = 2, default_qty_type = strategy.percent_of_equity,
     commission_type = strategy.commission.percent, commission_value = 1
 )

length = input.int(10, &quot;Length&quot;)

float highest = ta.highest(close, length)
float lowest  = ta.lowest(close, length)

switch close
    highest =&gt; strategy.entry(&quot;Long&quot;, strategy.long)
    lowest  =&gt; strategy.close(&quot;Long&quot;)

plot(highest, color = color.new(color.lime, 50))
plot(lowest, color = color.new(color.red, 50))
</pre></div>
</div>
<p>As we can see in the example above, after applying a 1% commission to the backtest, the strategy simulated a
significantly reduced net profit of only 1.42% and a more volatile equity curve with an elevated max drawdown,
highlighting the impact commission simulation can have on a strategy’s test results.</p>
</div>
<div class="section" id="slippage-and-unfilled-limits">
<span id="pagestrategies-simulatingtradingcosts-slippageandlimits"></span><h3><a class="toc-backref" href="#id35">Slippage and unfilled limits</a><a class="headerlink" href="#slippage-and-unfilled-limits" title="Permalink to this headline">¶</a></h3>
<p>In real-life trading, a broker/exchange may fill orders at slightly different prices than a trader intended
due to volatility, liquidity, order size, and other market factors, which can profoundly impact a strategy’s
performance. The disparity between expected prices and the actual prices at which the broker/exchange executes
trades is what we refer to as slippage. Slippage is dynamic and unpredictable, making it impossible to simulate
precisely. However, factoring in a small amount of slippage on each trade during a backtest or forward test may
help the results better align with reality. Users can model slippage in their strategy results, sized as a fixed
number of ticks, by including a <code class="docutils literal notranslate"><span class="pre">slippage</span></code> argument in the
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy">strategy()</a>
declaration or by setting the “Slippage” input in the “Properties” tab of the strategy settings.</p>
<p>The following example demonstrates how slippage simulation affects the fill prices of market orders in a strategy
test. The script below places a “Buy” market order of 2% equity when the market price is above an EMA while the EMA
is rising and closes the position when the price dips below the EMA while it’s falling. We’ve included
<code class="docutils literal notranslate"><span class="pre">slippage</span> <span class="pre">=</span> <span class="pre">20</span></code> in the <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy">strategy()</a>
function, which declares that the price of each simulated order will slip 20 ticks in the direction of the trade. The script uses
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}opentrades{dot}entry_bar_index">strategy.opentrades.entry_bar_index()</a>
and <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}closedtrades{dot}exit_bar_index">strategy.closedtrades.exit_bar_index()</a>
to get the <code class="docutils literal notranslate"><span class="pre">entryIndex</span></code> and <code class="docutils literal notranslate"><span class="pre">exitIndex</span></code>, which it utilizes to obtain the <code class="docutils literal notranslate"><span class="pre">fillPrice</span></code> of the order. When the
bar index is at the <code class="docutils literal notranslate"><span class="pre">entryIndex</span></code>, the <code class="docutils literal notranslate"><span class="pre">fillPrice</span></code> is the first
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}opentrades{dot}entry_price">strategy.opentrades.entry_price()</a> value.
At the <code class="docutils literal notranslate"><span class="pre">exitIndex</span></code>, <code class="docutils literal notranslate"><span class="pre">fillPrice</span></code> is the
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}closedtrades{dot}exit_price">strategy.closedtrades.exit_price()</a>
value from the last closed trade. The script plots the expected fill price along with the
simulated fill price after slippage to visually compare the difference:</p>
<img alt="../_images/Strategies-Simulating-trading-costs-Slippage-and-unfilled-limits-1.png" src="../_images/Strategies-Simulating-trading-costs-Slippage-and-unfilled-limits-1.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(
     &quot;Slippage Demo&quot;, overlay = true, slippage = 20,
     default_qty_value = 2, default_qty_type = strategy.percent_of_equity
 )

int length = input.int(5, &quot;Length&quot;)

//@variable Exponential moving average with an input `length`.
float ma = ta.ema(close, length)

//@variable Returns `true` when `ma` has increased and `close` is greater than it, `false` otherwise.
bool longCondition = close &gt; ma and ma &gt; ma[1]
//@variable Returns `true` when `ma` has decreased and `close` is less than it, `false` otherwise.
bool shortCondition = close &lt; ma and ma &lt; ma[1]

// Enter a long market position on `longCondition`, close the position on `shortCondition`.
if longCondition
    strategy.entry(&quot;Buy&quot;, strategy.long)
if shortCondition
    strategy.close(&quot;Buy&quot;)

//@variable The `bar_index` of the position&#39;s entry order fill.
int entryIndex = strategy.opentrades.entry_bar_index(0)
//@variable The `bar_index` of the position&#39;s close order fill.
int exitIndex  = strategy.closedtrades.exit_bar_index(strategy.closedtrades - 1)

//@variable The fill price simulated by the strategy.
float fillPrice = switch bar_index
    entryIndex =&gt; strategy.opentrades.entry_price(0)
    exitIndex  =&gt; strategy.closedtrades.exit_price(strategy.closedtrades - 1)

//@variable The expected fill price of the open market position.
float expectedPrice = fillPrice ? open : na

color expectedColor = na
color filledColor   = na

if bar_index == entryIndex
    expectedColor := color.green
    filledColor   := color.blue
else if bar_index == exitIndex
    expectedColor := color.red
    filledColor   := color.fuchsia

plot(ma, color = color.new(color.orange, 50))

plotchar(fillPrice ? open : na, &quot;Expected fill price&quot;, &quot;—&quot;, location.absolute, expectedColor)
plotchar(fillPrice, &quot;Fill price after slippage&quot;, &quot;—&quot;, location.absolute, filledColor)
</pre></div>
</div>
<dl class="docutils">
<dt>Note that:</dt>
<dd><ul class="first last simple">
<li>Since the strategy applies constant slippage to all order fills, some orders can fill outside the
candle range in the simulation. Thus users should exercise caution with this setting, as excessive
simulated slippage can produce unrealistically worse testing results.</li>
</ul>
</dd>
</dl>
<p>Some traders may assume that they can avoid the adverse effects of slippage by using limit orders, as unlike
market orders, they cannot execute at a worse price than the specified value. However, depending on the state
of the real-life market, even if the market price reaches an order price, there’s a chance that a limit order
may not fill, as limit orders can only fill if a security has sufficient liquidity and price action around the
value. To account for the possibility of unfilled orders in a backtest, users can specify the
<code class="docutils literal notranslate"><span class="pre">backtest_fill_limits_assumption</span></code> value in the declaration statement or use the “Verify price for limit orders”
input in the “Properties” tab to instruct the strategy to fill limit orders only after prices move a defined
number of ticks past order prices.</p>
<p>The following example places a limit order of 2% equity at a bar’s <code class="docutils literal notranslate"><span class="pre">hlcc4</span></code> when the <code class="docutils literal notranslate"><span class="pre">high</span></code> is the <code class="docutils literal notranslate"><span class="pre">highest</span></code>
value over the past <code class="docutils literal notranslate"><span class="pre">length</span></code> bars and there are no pending entries. The strategy closes the market position and
cancels all orders when the <code class="docutils literal notranslate"><span class="pre">low</span></code> is the <code class="docutils literal notranslate"><span class="pre">lowest</span></code> value. Each time the strategy triggers an order, it draws a
horizontal line at the <code class="docutils literal notranslate"><span class="pre">limitPrice</span></code>, which it updates on each bar until closing the position or canceling the order:</p>
<img alt="../_images/Strategies-Simulating-trading-costs-Slippage-and-unfilled-limits-2.png" src="../_images/Strategies-Simulating-trading-costs-Slippage-and-unfilled-limits-2.png" />
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
strategy(
     &quot;Verify price for limits example&quot;, overlay = true,
     default_qty_type = strategy.percent_of_equity, default_qty_value = 2
 )

int length = input.int(25, title = &quot;Length&quot;)

//@variable Draws a line at the limit price of the most recent entry order.
var line limitLine = na

// Highest high and lowest low
highest = ta.highest(length)
lowest  = ta.lowest(length)

// Place an entry order and draw a new line when the the `high` equals the `highest` value and `limitLine` is `na`.
if high == highest and na(limitLine)
    float limitPrice = hlcc4
    strategy.entry(&quot;Long&quot;, strategy.long, limit = limitPrice)
    limitLine := line.new(bar_index, limitPrice, bar_index + 1, limitPrice)

// Close the open market position, cancel orders, and set `limitLine` to `na` when the `low` equals the `lowest` value.
if low == lowest
    strategy.cancel_all()
    limitLine := na
    strategy.close_all()

// Update the `x2` value of `limitLine` if it isn&#39;t `na`.
if not na(limitLine)
    limitLine.set_x2(bar_index + 1)

plot(highest, &quot;Highest High&quot;, color = color.new(color.green, 50))
plot(lowest, &quot;Lowest Low&quot;, color = color.new(color.red, 50))
</pre></div>
</div>
<p>By default, the script assumes that all limit orders are guaranteed to fill. However, this is often not the case
in real-life trading. Let’s add price verification to our limit orders to account for potentially unfilled ones.
In this example, we’ve included <code class="docutils literal notranslate"><span class="pre">backtest_fill_limits_assumption</span> <span class="pre">=</span> <span class="pre">3</span></code> in the
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy">strategy()</a> function call.
As we can see, using limit verification omits some simulated order fills and changes the times of others since the
entry orders can now only fill after the price penetrates the limit price by three ticks:</p>
<img alt="../_images/Strategies-Simulating-trading-costs-Slippage-and-unfilled-limits-3.png" src="../_images/Strategies-Simulating-trading-costs-Slippage-and-unfilled-limits-3.png" />
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It’s important to notice that although the limit verification changed the <em>times</em> of some order fills, the strategy
simulated them at the same <em>prices</em>. This “time-warping” effect is a compromise that preserves the prices of verified
limit orders, but it can cause the strategy to simulate their fills at times that wouldn’t necessarily be possible in
the real world. Users should exercise caution with this setting and understand its limitations when analyzing strategy
results.</p>
</div>
</div>
</div>
<div class="section" id="risk-management">
<span id="pagestrategies-riskmanagement"></span><h2><a class="toc-backref" href="#id36">Risk management</a><a class="headerlink" href="#risk-management" title="Permalink to this headline">¶</a></h2>
<p>Designing a strategy that performs well, let alone one that does so in a broad class
of markets, is a challenging task. Most are designed for specific market patterns/conditions
and may produce uncontrollable losses when applied to other data. Therefore, a strategy’s
risk management qualities can be critical to its performance. Users can set risk management
criteria in their strategy scripts using the special commands with the <code class="docutils literal notranslate"><span class="pre">strategy.risk</span></code> prefix.</p>
<p>Strategies can incorporate any number of risk management criteria in any combination. All risk
management commands execute on every tick and order execution event, regardless of any changes
to the strategy’s calculation behavior. There is no way to disable any of these commands at a
script’s runtime. Irrespective of the risk rule’s location, it will always apply to the strategy
unless the user removes the call from the code.</p>
<dl class="docutils">
<dt><a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}risk{dot}allow_entry_in">strategy.risk.allow_entry_in()</a></dt>
<dd>This command overrides the market direction allowed for
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}entry">strategy.entry()</a>
commands. When a user specifies the trade direction with this function (e.g.,
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#var_strategy{dot}direction{dot}long">strategy.direction.long</a>),
the strategy will only enter trades in that direction. However, it’s important to note that
if a script calls an entry command in the opposite direction while there’s an open market
position, the strategy will simulate a market order to exit the position.</dd>
<dt><a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}risk{dot}max_cons_loss_days">strategy.risk.max_cons_loss_days()</a></dt>
<dd>This command cancels all pending orders, closes the open market position, and stops all
additional trade actions after the strategy simulates a defined number of trading days
with consecutive losses.</dd>
<dt><a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}risk{dot}max_drawdown">strategy.risk.max_drawdown()</a></dt>
<dd>This command cancels all pending orders, closes the open market position, and stops all
additional trade actions after the strategy’s drawdown reaches the amount specified in
the function call.</dd>
<dt><a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}risk{dot}max_intraday_filled_orders">strategy.risk.max_intraday_filled_orders()</a></dt>
<dd>This command specifies the maximum number of filled orders per trading day (or per chart bar
if the timeframe is higher than daily). Once the strategy executes the maximum number of orders
for the day, it cancels all pending orders, closes the open market position, and halts trading
activity until the end of the current session.</dd>
<dt><a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}risk{dot}max_intraday_loss">strategy.risk.max_intraday_loss()</a></dt>
<dd>This command controls the maximum loss the strategy will tolerate per trading day (or per chart
bar if the timeframe is higher than daily). When the strategy’s losses reach this threshold, it
will cancel all pending orders, close the open market position, and stop all trading activity
until the end of the current session.</dd>
<dt><a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}risk{dot}max_position_size">strategy.risk.max_position_size()</a></dt>
<dd>This command specifies the maximum possible position size when using
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy{dot}entry">strategy.entry()</a>
commands. If the quantity of an entry command results in a market position that exceeds this
threshold, the strategy will reduce the order quantity so that the resulting position does
not exceed the limitation.</dd>
</dl>
</div>
<div class="section" id="margin">
<span id="pagestrategies-margin"></span><h2><a class="toc-backref" href="#id37">Margin</a><a class="headerlink" href="#margin" title="Permalink to this headline">¶</a></h2>
<p>Margin is the minimum percentage of a market position a trader must hold in their account as
collateral to receive and sustain a loan from their broker to achieve their desired leverage.
The <code class="docutils literal notranslate"><span class="pre">margin_long</span></code> and <code class="docutils literal notranslate"><span class="pre">margin_short</span></code> parameters of the
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy">strategy()</a>
declaration and the “Margin for long/short positions” inputs in the “Properties” tab of the
script settings allow strategies to specify margin percentages for long and short positions.
For example, if a trader sets the margin for long positions to 25%, they must have enough funds
to cover 25% of an open long position. This margin percentage also means the trader can
potentially spend up to 400% of their equity on their trades.</p>
<p>If a strategy’s simulated funds cannot cover the losses from a margin trade, the broker emulator
triggers a margin call, which forcibly liquidates all or part of the position. The exact number
of contracts/shares/lots/units that the emulator liquidates is four times what is required to cover
a loss to prevent constant margin calls on subsequent bars. The emulator calculates the amount
using the following algorithm:</p>
<ol class="arabic simple">
<li>Calculate the amount of capital spent on the position: <code class="docutils literal notranslate"><span class="pre">Money</span> <span class="pre">Spent</span> <span class="pre">=</span> <span class="pre">Quantity</span> <span class="pre">*</span> <span class="pre">Entry</span> <span class="pre">Price</span></code></li>
<li>Calculate the Market Value of Security (MVS): <code class="docutils literal notranslate"><span class="pre">MVS</span> <span class="pre">=</span> <span class="pre">Position</span> <span class="pre">Size</span> <span class="pre">*</span> <span class="pre">Current</span> <span class="pre">Price</span></code></li>
<li>Calculate the Open Profit as the difference between <code class="docutils literal notranslate"><span class="pre">MVS</span></code> and <code class="docutils literal notranslate"><span class="pre">Money</span> <span class="pre">Spent</span></code>. If the position is short, we multiply this by -1.</li>
<li>Calculate the strategy’s equity value: <code class="docutils literal notranslate"><span class="pre">Equity</span> <span class="pre">=</span> <span class="pre">Initial</span> <span class="pre">Capital</span> <span class="pre">+</span> <span class="pre">Net</span> <span class="pre">Profit</span> <span class="pre">+</span> <span class="pre">Open</span> <span class="pre">Profit</span></code></li>
<li>Calculate the margin ratio: <code class="docutils literal notranslate"><span class="pre">Margin</span> <span class="pre">Ratio</span> <span class="pre">=</span> <span class="pre">Margin</span> <span class="pre">Percent</span> <span class="pre">/</span> <span class="pre">100</span></code></li>
<li>Calculate the margin value, which is the cash required to cover the trader’s portion of the position: <code class="docutils literal notranslate"><span class="pre">Margin</span> <span class="pre">=</span> <span class="pre">MVS</span> <span class="pre">*</span> <span class="pre">Margin</span> <span class="pre">Ratio</span></code></li>
<li>Calculate the available funds: <code class="docutils literal notranslate"><span class="pre">Available</span> <span class="pre">Funds</span> <span class="pre">=</span> <span class="pre">Equity</span> <span class="pre">-</span> <span class="pre">Margin</span></code></li>
<li>Calculate the total amount of money the trader has lost: <code class="docutils literal notranslate"><span class="pre">Loss</span> <span class="pre">=</span> <span class="pre">Available</span> <span class="pre">Funds</span> <span class="pre">/</span> <span class="pre">Margin</span> <span class="pre">Ratio</span></code></li>
<li>Calculate how many contracts/shares/lots/units the trader would need to liquidate to cover the loss. We truncate this value to the same decimal precision as the minimum position size for the current symbol: <code class="docutils literal notranslate"><span class="pre">Cover</span> <span class="pre">Amount</span> <span class="pre">=</span> <span class="pre">TRUNCATE(Loss</span> <span class="pre">/</span> <span class="pre">Current</span> <span class="pre">Price).</span></code></li>
<li>Calculate how many units the broker will liquidate to cover the loss: <code class="docutils literal notranslate"><span class="pre">Margin</span> <span class="pre">Call</span> <span class="pre">=</span> <span class="pre">Cover</span> <span class="pre">Amount</span> <span class="pre">*</span> <span class="pre">4</span></code></li>
</ol>
<p>To examine this calculation in detail, let’s add the built-in Supertrend Strategy to the NASDAQ:TSLA chart on the 1D timeframe and set the
“Order size” to 300% of equity and the “Margin for long positions” to 25% in the “Properties” tab of the strategy settings:</p>
<img alt="../_images/Strategies-Margin-1.png" src="../_images/Strategies-Margin-1.png" />
<p>The first entry happened at the bar’s opening price on 16 Sep 2010. The strategy bought 682,438 shares (Position size)
at 4.43 USD (Entry price). Then, on 23 Sep 2010, when the price dipped to 3.9 (Current price), the emulator forcibly
liquidated 111,052 shares via margin call.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Money spent: 682438 * 4.43 = 3023200.34
MVS: 682438 * 3.9 = 2661508.2
Open Profit: −361692.14
Equity: 1000000 + 0 − 361692.14 = 638307.86
Margin Ratio: 25 / 100 = 0.25
Margin: 2661508.2 * 0.25 = 665377.05
Available Funds: 638307.86 - 665377.05 = -27069.19
Money Lost: -27069.19 / 0.25 = -108276.76
Cover Amount: TRUNCATE(-108276.76 / 3.9) = TRUNCATE(-27763.27) = -27763
Margin Call Size: -27763 * 4 = - 111052
</pre></div>
</div>
</div>
<div class="section" id="strategy-alerts">
<span id="pagestrategies-strategyalerts"></span><h2><a class="toc-backref" href="#id38">Strategy Alerts</a><a class="headerlink" href="#strategy-alerts" title="Permalink to this headline">¶</a></h2>
<p>Regular Pine Script<sup>®</sup> indicators have two different mechanisms to set up custom alert conditions:
the <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_alertcondition">alertcondition()</a>
function, which tracks one specific condition per function call,
and the <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_alert">alert()</a>
function, which tracks all its calls simultaneously, but provides greater flexibility in the
number of calls, alert messages, etc.</p>
<p>Pine Script<sup>®</sup> strategies do not work with
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_alertcondition">alertcondition()</a>
calls, but they do support the generation of custom alerts via the
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_alert">alert()</a> function.
Along with this, each function that creates orders also comes with its own built-in alert
functionality that does not require any additional code to implement. As such, any strategy that
uses an order placement command can issue alerts upon order execution. The precise mechanics of such
built-in strategy alerts are described in the
<span class="xref std std-ref">Order Fill events</span> section of the
<a class="reference internal" href="Alerts.html#pagealerts"><span class="std std-ref">Alerts</span></a> page in our User Manual.</p>
<p>When a strategy uses functions that create orders and the <code class="docutils literal notranslate"><span class="pre">alert()</span></code> function together, the alert
creation dialogue provides a choice between the conditions that it will trigger upon: it can trigger
on <code class="docutils literal notranslate"><span class="pre">alert()</span></code> events, order fill events, or both.</p>
<p>For many trading strategies, the latency between a triggered condition and a live trade can be a
critical performance factor. By default, strategy scripts can only execute
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_alert">alert()</a>
function calls on the close of real-time bars, considering them to use
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#var_alert{dot}freq_once_per_bar_close">alert.freq_once_per_bar_close</a>,
regardless of the <code class="docutils literal notranslate"><span class="pre">freq</span></code> argument in the call. Users can change the alert frequency by also including
<code class="docutils literal notranslate"><span class="pre">calc_on_every_tick</span> <span class="pre">=</span> <span class="pre">true</span></code> in the <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy">strategy()</a>
call or selecting the “Recalculate on every tick” option in the “Properties” tab of the strategy settings
before creating the alert. However, depending on the script, this may also adversely impact a strategy’s
behavior, so exercise caution and be aware of the limitations when using this approach.</p>
<p>When sending alerts to a third party for strategy automation, we recommend using order fill alerts
rather than the <a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_alert">alert()</a>
function since they don’t suffer the same limitations; alerts from order fill events execute immediately,
unaffected by a script’s <code class="docutils literal notranslate"><span class="pre">calc_on_every_tick</span></code> setting. Users can set the default message for order fill
alerts via the <code class="docutils literal notranslate"><span class="pre">&#64;strategy_alert_message</span></code> compiler annotation. The text provided with this annotation
will populate the “Message” field for order fills in the alert creation dialogue.</p>
<p>The following script shows a simple example of a default order fill alert message. Above the
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#fun_strategy">strategy()</a> declaration
statement, it uses <code class="docutils literal notranslate"><span class="pre">&#64;strategy_alert_message</span></code> with <em>placeholders</em> for the
trade action, position size, ticker, and fill price values in the message text:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=5
//@strategy_alert_message {{strategy.order.action}} {{strategy.position_size}} {{ticker}} @ {{strategy.order.price}}
strategy(&quot;Alert Message Demo&quot;, overlay = true)
float fastMa = ta.sma(close, 5)
float slowMa = ta.sma(close, 10)

if ta.crossover(fastMa, slowMa)
    strategy.entry(&quot;buy&quot;, strategy.long)

if ta.crossunder(fastMa, slowMa)
    strategy.entry(&quot;sell&quot;, strategy.short)

plot(fastMa, &quot;Fast MA&quot;, color.aqua)
plot(slowMa, &quot;Slow MA&quot;, color.orange)
</pre></div>
</div>
<p>This script will populate the alert creation dialogue with its default message when the user selects its name from the
“Condition” dropdown tab:</p>
<img alt="../_images/Strategies-Strategy-alerts-1.png" src="../_images/Strategies-Strategy-alerts-1.png" />
<p>Upon the alert trigger, the strategy will populate the placeholders in the alert message with their corresponding values.
For example:</p>
<img alt="../_images/Strategies-Strategy-alerts-2.png" src="../_images/Strategies-Strategy-alerts-2.png" />
</div>
<div class="section" id="notes-on-testing-strategies">
<span id="pagestrategies-notesontestingstrategies"></span><h2><a class="toc-backref" href="#id39">Notes on testing strategies</a><a class="headerlink" href="#notes-on-testing-strategies" title="Permalink to this headline">¶</a></h2>
<p>It’s common for traders to test and tune their strategies in historical and real-time market
conditions because many believe that analyzing the results may provide valuable insight into
a strategy’s characteristics, potential weaknesses, and possibly its future potential. However,
traders should always be aware of the biases and limitations of simulated strategy results,
especially when using the results to support live trading decisions. This section outlines some
caveats associated with strategy validation and tuning and possible solutions to mitigate their effects.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">While testing strategies on existing data may give traders helpful information about a strategy’s
qualities, it’s important to note that neither the past nor the present guarantees the future.
Financial markets can change rapidly and unpredictably, which may cause a strategy to sustain
uncontrollable losses. Additionally, simulated results may not fully account for other real-world
factors that can impact trading performance. Therefore, we recommend that traders thoroughly
understand the limitations and risks when evaluating backtests and forward tests and consider them
“parts of the whole” in their validation processes rather than basing decisions solely on the results.</p>
</div>
<div class="section" id="backtesting-and-forward-testing">
<span id="pagestrategies-notesontestingstrategies-backtestingandforwardtesting"></span><h3><a class="toc-backref" href="#id40">Backtesting and forward testing</a><a class="headerlink" href="#backtesting-and-forward-testing" title="Permalink to this headline">¶</a></h3>
<p>Backtesting is a technique that traders use to evaluate the historical performance of a trading
strategy or model by simulating and analyzing its past results on historical market data;
this technique assumes that analysis of a strategy’s results on past data may provide insight into
its strengths and weaknesses. When backtesting, many traders tweak the parameters of a strategy
in an attempt to optimize its results. Analysis and optimization of historical results may help
traders to gain a deeper understanding of a strategy. However, traders should always understand
the risks and limitations when basing their decisions on optimized backtest results.</p>
<p>Parallel to backtesting, prudent trading system development often also involves incorporating
real-time analysis as a tool for evaluating a trading system on a forward-looking basis. Forward
testing aims to gauge the performance of a strategy in real-time, real-world market conditions,
where factors such as trading costs, slippage, and liquidity can meaningfully affect its performance.
Forward testing has the distinct advantage of not being affected by certain types of biases
(e.g., lookahead bias or “future data leakage”) but carries the disadvantage of being limited in
the quantity of data to test. Therefore, it’s not typically a standalone solution for strategy
validation, but it can provide helpful insights into a strategy’s performance in current market conditions.</p>
<p>Backtesting and forward testing are two sides of the same coin, as both approaches aim to validate
the effectiveness of a strategy and identify its strengths and weaknesses. By combining backtesting
and forward testing, traders may be able to compensate for some limitations and gain a clearer perspective
on their strategy’s performance. However, it’s up to traders to sanitize their strategies and evaluation
processes to ensure that insights align with reality as closely as possible.</p>
</div>
<div class="section" id="lookahead-bias">
<span id="pagestrategies-notesontestingstrategies-lookaheadbias"></span><h3><a class="toc-backref" href="#id41">Lookahead bias</a><a class="headerlink" href="#lookahead-bias" title="Permalink to this headline">¶</a></h3>
<p>One typical issue in backtesting some strategies, namely ones that request alternate timeframe data,
use repainting variables such as <a class="reference external" href="../../../../pine-script-reference/v5/index.html#var_timenow">timenow</a>,
or alter calculation behavior for intrabar order fills, is the leakage of future data into the past
during evaluation, which is known as lookahead bias. Not only is this bias a common cause of unrealistic
strategy results since the future is never actually knowable beforehand, but it is also one of the
typical causes of strategy repainting. Traders can often confirm this bias by forward testing their
systems, as lookahead bias does not apply to real-time data where no known data exists beyond the current
bar. Users can eliminate this bias in their strategies by ensuring that they don’t use repainting variables that leak
the future into the past, <code class="docutils literal notranslate"><span class="pre">request.*()</span></code> functions don’t include
<a class="reference external" href="../../../../pine-script-reference/v5/index.html#var_barmerge{dot}lookahead_on">barmerge.lookahead_on</a>
without offsetting the data series as described on
<a class="reference external" href="Repainting33f2.html?highlight=barmerge#future-leak-with-request-security">this</a>
section of our page on <a class="reference internal" href="Repainting.html#pagerepainting"><span class="std std-ref">repainting</span></a>, and they use realistic calculation behavior.</p>
</div>
<div class="section" id="selection-bias">
<span id="pagestrategies-notesontestingstrategies-selectionbias"></span><h3><a class="toc-backref" href="#id42">Selection bias</a><a class="headerlink" href="#selection-bias" title="Permalink to this headline">¶</a></h3>
<p>Selection bias is a common issue that many traders experience when testing their strategies. It occurs
when a trader only analyzes results on specific instruments or timeframes while ignoring others. This
bias can result in a distorted perspective of the strategy’s robustness, which may impact trading
decisions and performance optimizations. Traders can reduce the effects of selection bias by evaluating
their strategies on multiple, ideally diverse, symbols and timeframes, making it a point not to ignore
poor performance results in their analysis or cherry-pick testing ranges.</p>
</div>
<div class="section" id="overfitting">
<span id="pagestrategies-notesontestingstrategies-overfitting"></span><h3><a class="toc-backref" href="#id43">Overfitting</a><a class="headerlink" href="#overfitting" title="Permalink to this headline">¶</a></h3>
<p>A common pitfall when optimizing a backtest is the potential for overfitting (“curve fitting”),
which occurs when the strategy is tailored for specific data and fails to generalize well on new,
unseen data. One widely-used approach to help reduce the potential for overfitting and promote better
generalization is to split an instrument’s data into two or more parts to test the strategy outside
the sample used for optimization, otherwise known as “in-sample” (IS) and “out-of-sample” (OOS) backtesting.
In this approach, traders use the IS data for strategy optimization, while the OOS portion is used for
testing and evaluating IS-optimized performance on new data without further optimization. While this and other,
more robust approaches may provide a glimpse into how a strategy might fare after optimization, traders should
exercise caution, as the future is inherently unknowable. No trading strategy can guarantee future performance,
regardless of the data used for testing and optimization.</p>
<a class="reference external image-reference" href="https://www.tradingview.com/"><div align="center" class="align-center"><img alt="../_images/TradingView-Logo-Block.svg" src="../_images/TradingView-Logo-Block.svg" width="200px" /></div>
</a>
</div>
</div>
</div>


          </div>
            
  <div class="footer-relations">
    
      <div class="pull-left">
        <a class="btn btn-default" href="Sessions.html" title="previous chapter (use the left arrow)">Sessions</a>
      </div>
    
      <div class="pull-right">
        <a class="btn btn-default" href="Tables.html" title="next chapter (use the right arrow)">Tables</a>
      </div>
    </div>
    <div class="clearer"></div>
  
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="Tables.html" title="Tables"
             >next</a> |</li>
        <li class="right" >
          <a href="Sessions.html" title="Sessions"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Pine Script® v5 User Manual v5 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Concepts</a> &#187;</li> 
      </ul>
    </div>
<script type="text/javascript">
  $("#mobile-toggle a").click(function () {
    $("#left-column").toggle();
  });
</script>
<script type="text/javascript" src="../_static/js/bootstrap.js"></script>

<script type="text/javascript" src="../_static/js/theme.js"></script>


<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Options</span>
    v: v5
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Languages</dt>
      
        <strong>
        <dd><a href="Strategies.html">en</a></dd>
        </strong>
      
    </dl>
    <dl>
      <dt>Versions</dt>
      
        
        <dd><a href="https://www.tradingview.com/pine-script-docs/en/v3/concepts/Strategies.html">v3</a></dd>
        
      
        
        <dd><a href="https://www.tradingview.com/pine-script-docs/en/v4/concepts/Strategies.html">v4</a></dd>
        
      
        <strong>
        <dd><a href="Strategies.html">v5</a></dd>
        </strong>
      
    </dl>
  </div>
</div>
<script type="text/javascript">
    jQuery(function () {
        SphinxRtdTheme.Navigation.enable(false);
    });
</script>
  <div class="footer">
    &copy; Copyright 2023, TradingView.
  </div>
  </body>

<!-- Mirrored from www.tradingview.com/pine-script-docs/en/v5/concepts/Strategies.html by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 04 Sep 2023 17:56:40 GMT -->
</html>