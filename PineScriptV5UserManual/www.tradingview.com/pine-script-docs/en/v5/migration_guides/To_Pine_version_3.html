
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  
<!-- Mirrored from www.tradingview.com/pine-script-docs/en/v5/migration_guides/To_Pine_version_3.html by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 04 Sep 2023 17:57:06 GMT -->
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="../_static/fonts/open-sans/stylesheet.css" />
  <!-- Licensed under the SIL Open Font License -->
  <link rel="stylesheet" type="text/css" href="../_static/fonts/source-serif-pro/source-serif-pro.css" />
  <link rel="stylesheet" type="text/css" href="../_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="../_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>To Pine Script® version 3 &#8212; Pine Script® v5 User Manual v5 documentation</title>
    <link rel="stylesheet" href="../_static/guzzle.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <script type="text/javascript" src="../../../../../static.tradingview.com/static/bundles/pine-highlighter-v01.js"></script>
    <script type="text/javascript" src="../_static/highlight-pine-code.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Where can I get more information?" href="../Where_can_I_get_more_information.html" />
    <link rel="prev" title="To Pine Script® version 4" href="To_Pine_version_4.html" />
  
   

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../Where_can_I_get_more_information.html" title="Where can I get more information?"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="To_Pine_version_4.html" title="To Pine Script® version 4"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Pine Script® v5 User Manual v5 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Migration guides</a> &#187;</li> 
      </ul>
    </div>
    <div class="container-wrapper">

      <div id="mobile-toggle">
        <a href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
      </div>
  <div id="left-column">
    <div class="sphinxsidebar"><a href="../index.html" class="text-logo">Pine Script<sup>®</sup> v5 User Manual</a>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <h2>Table Of Contents</h2>
  </div>
  <div class="sidebar-toc">
    
    
      <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Introduction.html">Welcome to Pine Script<sup>®</sup> v5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../primer/index.html">Pine Script<sup>®</sup> primer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../language/index.html">Language</a></li>
<li class="toctree-l1"><a class="reference internal" href="../concepts/index.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../writing/index.html">Writing scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Error_messages.html">Error messages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Release_notes.html">Release notes</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Migration guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="To_Pine_version_5.html">To Pine Script<sup>®</sup> version 5</a></li>
<li class="toctree-l2"><a class="reference internal" href="To_Pine_version_4.html">To Pine Script<sup>®</sup> version 4</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">To Pine Script<sup>®</sup> version 3</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#default-behaviour-of-security-function-has-changed">Default behaviour of security function has changed</a></li>
<li class="toctree-l3"><a class="reference internal" href="#self-referenced-variables-are-removed">Self-referenced variables are removed</a></li>
<li class="toctree-l3"><a class="reference internal" href="#forward-referenced-variables-are-removed">Forward-referenced variables are removed</a></li>
<li class="toctree-l3"><a class="reference internal" href="#resolving-a-problem-with-a-mutable-variable-in-a-security-expression">Resolving a problem with a mutable variable in a security expression</a></li>
<li class="toctree-l3"><a class="reference internal" href="#math-operations-with-booleans-are-forbidden">Math operations with booleans are forbidden</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Where_can_I_get_more_information.html">Where can I get more information?</a></li>
</ul>

    
  </div>
</div>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <div id="main-search">
      <form class="form-inline" action="https://www.tradingview.com/pine-script-docs/en/v5/search.html" method="GET" role="form">
        <div class="input-group">
          <input name="q" type="text" class="form-control" placeholder="Search...">
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div>
      
    </div>
  </div>
        <div id="right-column">
          
          <div role="navigation" aria-label="breadcrumbs navigation">
            <ol class="breadcrumb">
              <li><a href="../index.html">User Manual</a></li>
              
                <li><a href="index.html">Migration guides</a></li>
              
              <li>To Pine Script<sup>®</sup> version 3</li>
            </ol>
          </div>
          
          <div class="document clearer body">
            
  <a class="reference external image-reference" href="../Introduction.html"><div align="right" class="align-right"><img alt="Pine Script® logo" height="100" src="../_images/Pine-script-logo.svg" width="100" /></div>
</a>
<div class="section" id="to-pine-script-version-3">
<span id="pagetopineversion3"></span><h1>To Pine Script<sup>®</sup> version 3<a class="headerlink" href="#to-pine-script-version-3" title="Permalink to this headline">¶</a></h1>
<p>This document helps to migrate Pine Script<sup>®</sup> code from <code class="docutils literal notranslate"><span class="pre">&#64;version=2</span></code> to
<code class="docutils literal notranslate"><span class="pre">&#64;version=3</span></code>.</p>
<div class="section" id="default-behaviour-of-security-function-has-changed">
<h2>Default behaviour of security function has changed<a class="headerlink" href="#default-behaviour-of-security-function-has-changed" title="Permalink to this headline">¶</a></h2>
<p>Let’s look at the simple <code class="docutils literal notranslate"><span class="pre">security</span></code> function use case. Add this
indicator on an intraday chart:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>// Add this indicator on an intraday (e.g., 30 minutes) chart
//@version=2
study(&quot;My Script&quot;, overlay=true)
s = security(tickerid, &#39;D&#39;, high, false)
plot(s)
</pre></div>
</div>
<p>This indicator is calculated based on historical data and looks somewhat
<em>into the future</em>. At the first bar of every session an indicator plots
the high price of the entire day. This could be useful in some cases for
analysis, but doesn’t work for backtesting strategies.</p>
<p>We worked on this and made changes in Pine Script<sup>®</sup> version 3. If this indicator is
compiled with <code class="docutils literal notranslate"><span class="pre">//&#64;version=3</span></code> directive, we get a completely different
picture: <img alt="images/V3.png" src="../_images/V3.png" /></p>
<p>The old behaviour is still available though. We added a parameter to the
<code class="docutils literal notranslate"><span class="pre">security</span></code> function (the fifth one) called <code class="docutils literal notranslate"><span class="pre">lookahead</span></code>.</p>
<p>It can take on the form of two different values:
<code class="docutils literal notranslate"><span class="pre">barmerge.lookahead_off</span></code> (and this is the default for Pine Script<sup>®</sup> version 3) or
<code class="docutils literal notranslate"><span class="pre">barmerge.lookahead_on</span></code> (which is the default for Pine Script<sup>®</sup> version 2).</p>
</div>
<div class="section" id="self-referenced-variables-are-removed">
<h2>Self-referenced variables are removed<a class="headerlink" href="#self-referenced-variables-are-removed" title="Permalink to this headline">¶</a></h2>
<p>Pine Script<sup>®</sup> version 2 pieces of code, containing a self-referencing variable:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=2
//...
s = nz(s[1]) + close
</pre></div>
</div>
<p>Compiling this piece of code with Pine Script<sup>®</sup> version 3 will give you an
<code class="docutils literal notranslate"><span class="pre">Undeclared</span> <span class="pre">identifier</span> <span class="pre">'s'</span></code> error. It should be rewritten as:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=3
//...
s = 0.0
s := nz(s[1]) + close
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">s</span></code> is now a <em>mutable variable</em> that is initialized at line 3. At line 3
the initial value gives the Pine Script<sup>®</sup> compiler the information about the
variable type. It’s a float in this example.</p>
<p>In some cases you may initialize that mutable variable (like <code class="docutils literal notranslate"><span class="pre">s</span></code>) with
a <code class="docutils literal notranslate"><span class="pre">na</span></code> value. But in complex cases that won’t work.</p>
</div>
<div class="section" id="forward-referenced-variables-are-removed">
<h2>Forward-referenced variables are removed<a class="headerlink" href="#forward-referenced-variables-are-removed" title="Permalink to this headline">¶</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=2
//...
d = nz(f[1])
e = d + 1
f = e + close
</pre></div>
</div>
<p>In this example <code class="docutils literal notranslate"><span class="pre">f</span></code> is a forward-referencing variable, because it’s
referenced at line 3 before it was declared and initialized. In Pine Script<sup>®</sup> version 3
this will give you an error <code class="docutils literal notranslate"><span class="pre">Undeclared</span> <span class="pre">identifier</span> <span class="pre">'f'</span></code>. This example
should be rewritten in Pine Script<sup>®</sup> version 3 as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=3
//...
f = 0.0
d = nz(f[1])
e = d + 1
f := e + close
</pre></div>
</div>
</div>
<div class="section" id="resolving-a-problem-with-a-mutable-variable-in-a-security-expression">
<h2>Resolving a problem with a mutable variable in a security expression<a class="headerlink" href="#resolving-a-problem-with-a-mutable-variable-in-a-security-expression" title="Permalink to this headline">¶</a></h2>
<p>When you migrate script to version 3 it’s possible that after removing
self-referencing and forward-referencing variables the Pine Script<sup>®</sup> compiler
will give you an error:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=3
//...
s = 0.0
s := nz(s[1]) + close
t = security(tickerid, period, s)
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Cannot</span> <span class="pre">use</span> <span class="pre">mutable</span> <span class="pre">variable</span> <span class="pre">as</span> <span class="pre">an</span> <span class="pre">argument</span> <span class="pre">for</span> <span class="pre">security</span> <span class="pre">function!</span></code></p>
<p>This limitation exists since mutable variables were introduced in Pine Script<sup>®</sup>,
i.e., in version 2. It can be resolved as before: wrap the code with a mutable
variable in a function:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=3
//...
calcS() =&gt;
    s = 0.0
    s := nz(s[1]) + close
t = security(tickerid, period, calcS())
</pre></div>
</div>
</div>
<div class="section" id="math-operations-with-booleans-are-forbidden">
<h2>Math operations with booleans are forbidden<a class="headerlink" href="#math-operations-with-booleans-are-forbidden" title="Permalink to this headline">¶</a></h2>
<p>In Pine Script<sup>®</sup> v2 there were rules of implicit conversion of booleans
into numeric types. In v3 this is forbidden. There is a conversion of
numeric types into booleans instead (0 and <code class="docutils literal notranslate"><span class="pre">na</span></code> values are <code class="docutils literal notranslate"><span class="pre">false</span></code>, all
the other numbers are <code class="docutils literal notranslate"><span class="pre">true</span></code>). Example (In v2 this code compiles fine):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=2
study(&quot;My Script&quot;)
s = close &gt;= open
s1 = close[1] &gt;= open[1]
s2 = close[2] &gt;= open[2]
sum = s + s1 + s2
col = sum == 1 ? white : sum == 2 ? blue : sum == 3 ? red : na
bgcolor(col)
</pre></div>
</div>
<p>Variables <code class="docutils literal notranslate"><span class="pre">s</span></code>, <code class="docutils literal notranslate"><span class="pre">s1</span></code> and <code class="docutils literal notranslate"><span class="pre">s2</span></code> are of <em>bool</em> type. But at line 6 we
add three of them and store the result in a variable <code class="docutils literal notranslate"><span class="pre">sum</span></code>. <code class="docutils literal notranslate"><span class="pre">sum</span></code> is
a number, since we cannot add booleans. Booleans were implicitly
converted to numbers (<code class="docutils literal notranslate"><span class="pre">true</span></code> values to <code class="docutils literal notranslate"><span class="pre">1.0</span></code> and <code class="docutils literal notranslate"><span class="pre">false</span></code> to <code class="docutils literal notranslate"><span class="pre">0.0</span></code>) and then they
were added.</p>
<p>This approach leads to unintentional errors in more complicated scripts.
That’s why we no longer allow implicit conversion of booleans to
numbers.</p>
<p>If you try to compile this example as a Pine Script<sup>®</sup> v3 code, you’ll get an
error:
<code class="docutils literal notranslate"><span class="pre">Cannot</span> <span class="pre">call</span> <span class="pre">`operator</span> <span class="pre">+`</span> <span class="pre">with</span> <span class="pre">arguments</span> <span class="pre">(series__bool,</span> <span class="pre">series__bool);</span> <span class="pre">&lt;...&gt;</span></code>
It means that you cannot use the addition operator with boolean values.
To make this example work in Pine Script<sup>®</sup> v3 you can do the following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>//@version=3
study(&quot;My Script&quot;)
bton(b) =&gt;
    b ? 1 : 0
s = close &gt;= open
s1 = close[1] &gt;= open[1]
s2 = close[2] &gt;= open[2]
sum = bton(s) + bton(s1) + bton(s2)
col = sum == 1 ? white : sum == 2 ? blue : sum == 3 ? red : na
bgcolor(col)
</pre></div>
</div>
<p>Function <code class="docutils literal notranslate"><span class="pre">bton</span></code> (abbreviation of boolean-to-number) explicitly
converts any boolean value to a number if you really need this.</p>
<a class="reference external image-reference" href="https://www.tradingview.com/"><div align="center" class="align-center"><img alt="../_images/TradingView-Logo-Block.svg" src="../_images/TradingView-Logo-Block.svg" width="200px" /></div>
</a>
</div>
</div>


          </div>
            
  <div class="footer-relations">
    
      <div class="pull-left">
        <a class="btn btn-default" href="To_Pine_version_4.html" title="previous chapter (use the left arrow)">To Pine Script<sup>®</sup> version 4</a>
      </div>
    
      <div class="pull-right">
        <a class="btn btn-default" href="../Where_can_I_get_more_information.html" title="next chapter (use the right arrow)">Where can I get more information?</a>
      </div>
    </div>
    <div class="clearer"></div>
  
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../Where_can_I_get_more_information.html" title="Where can I get more information?"
             >next</a> |</li>
        <li class="right" >
          <a href="To_Pine_version_4.html" title="To Pine Script® version 4"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Pine Script® v5 User Manual v5 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Migration guides</a> &#187;</li> 
      </ul>
    </div>
<script type="text/javascript">
  $("#mobile-toggle a").click(function () {
    $("#left-column").toggle();
  });
</script>
<script type="text/javascript" src="../_static/js/bootstrap.js"></script>

<script type="text/javascript" src="../_static/js/theme.js"></script>


<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Options</span>
    v: v5
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Languages</dt>
      
        <strong>
        <dd><a href="To_Pine_version_3.html">en</a></dd>
        </strong>
      
    </dl>
    <dl>
      <dt>Versions</dt>
      
        
        <dd><a href="https://www.tradingview.com/pine-script-docs/en/v3/migration_guides/To_Pine_version_3.html">v3</a></dd>
        
      
        
        <dd><a href="https://www.tradingview.com/pine-script-docs/en/v4/migration_guides/To_Pine_version_3.html">v4</a></dd>
        
      
        <strong>
        <dd><a href="To_Pine_version_3.html">v5</a></dd>
        </strong>
      
    </dl>
  </div>
</div>
<script type="text/javascript">
    jQuery(function () {
        SphinxRtdTheme.Navigation.enable(false);
    });
</script>
  <div class="footer">
    &copy; Copyright 2023, TradingView.
  </div>
  </body>

<!-- Mirrored from www.tradingview.com/pine-script-docs/en/v5/migration_guides/To_Pine_version_3.html by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 04 Sep 2023 17:57:07 GMT -->
</html>